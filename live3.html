<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Masjid Display â€” Prayer Times</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Teko:wght@500;600&family=Work+Sans:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bs-primary: #bf9456;
      --bs-primary-rgb: 191, 148, 86;
      --bs-body-bg: #1a1a1a;
      --bs-body-color: #e0e0e0;
      --surface-color: #242424;
      --text-secondary-color: #a0a0a0;
      --highlight-color: #d4af37;
      
      /* Fluid Font Sizes */
      --font-size-sm: clamp(1rem, 2.5vh, 1.5rem);
      --font-size-md: clamp(1.2rem, 3.5vh, 2rem);
      --font-size-lg: clamp(1.8rem, 6vh, 3.5rem);
      --font-size-xl: clamp(2.2rem, 8vh, 4.5rem);
      --font-size-xxl: clamp(5rem, 20vh, 16rem);
    }

    body {
      font-family: 'Work Sans', sans-serif;
      overflow: hidden;
    }

    .font-teko { font-family: 'Teko', sans-serif; }

    .panel {
      background-color: var(--surface-color);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.03), 0 10px 40px rgba(0, 0, 0, 0.55);
    }
    
    .masjid-logo {
      max-width: clamp(200px, 30vw, 450px);
      cursor: pointer;
      transition: transform .25s ease;
    }
    .masjid-logo:hover { transform: scale(1.02); }
    .masjid-logo img {
      filter: invert(75%) sepia(13%) saturate(1558%) hue-rotate(359deg) brightness(91%) contrast(88%);
    }

    .clock-time {
      font-size: var(--font-size-xxl);
      line-height: 0.9;
      text-shadow: 0 0 30px rgba(212, 175, 55, 0.25);
    }
    .gregorian { font-size: var(--font-size-md); }
    .hijri { font-size: var(--font-size-sm); }
    
    .message-block {
      background: rgba(0,0,0,0.2);
      min-height: 10vmin;
    }
    .message-viewport { overflow: hidden; position: relative; width: 100%; height: 100%; }
    .message-content {
      color: var(--text-secondary-color);
      font-size: var(--font-size-sm);
      font-style: italic;
    }
    .message-scroller { display: block; }
    
    .prayer-item {
      border-left: 6px solid transparent;
      transition: all 0.3s ease-in-out;
    }
    .prayer-item.active {
      background: linear-gradient(90deg, rgba(191,148,86,0.15), transparent);
      border-left-color: var(--highlight-color);
    }
    .prayer-item.active .prayer-name,
    .prayer-item.active .jamaat-time .time-block-time { color: var(--bs-primary); }

    .prayer-name { font-size: var(--font-size-lg); }
    .time-block-label { font-size: var(--font-size-sm); color: var(--text-secondary-color); }
    .time-block-time { font-size: var(--font-size-xl); line-height: 1.1; }
    .start-time .time-block-time {
      font-size: var(--font-size-lg);
      color: var(--text-secondary-color);
      font-weight: 500 !important;
    }
    
    .info-mini {
      background: rgba(0,0,0,0.2);
      border: 1px solid transparent;
      transition: all 0.3s ease;
    }
    .info-mini .time-label { font-weight: 600; font-size: var(--font-size-sm); }
    .info-mini .time { font-size: var(--font-size-md); margin-top: 0.5vmin; }
    .info-mini.active {
      border-color: rgba(212, 175, 55, 0.2);
      animation: breathe-info 3.6s ease-in-out infinite;
    }
    @keyframes breathe-info {
      0% { box-shadow: 0 0 15px rgba(212, 175, 55, 0.05); }
      50% { box-shadow: 0 0 30px rgba(212, 175, 55, 0.12); }
      100% { box-shadow: 0 0 15px rgba(212, 175, 55, 0.05); }
    }
    
    .phone-overlay {
      background: rgba(0,0,0,0.9);
      visibility: hidden; opacity: 0; transition: opacity .35s ease, visibility .35s;
    }
    .phone-overlay.visible { visibility: visible; opacity: 1; }
    .phone-overlay .text { font-size: clamp(2rem, 10vmin, 6rem); }
    .phone-overlay .smalltime { font-size: clamp(1.5rem, 8vmin, 4rem); }
  </style>
</head>
<body class="d-flex flex-column vh-100 p-3">

  <main class="container-fluid flex-grow-1 d-flex flex-column">
    <div class="row flex-grow-1 g-3">
      <!-- Left Panel -->
      <div class="col-lg-5 d-flex flex-column">
        <div class="panel d-flex flex-column h-100 p-4">
          <div class="masjid-logo mx-auto" id="logo-toggle" title="Click to toggle fullscreen">
            <img src="https://www.wakefieldcentralmosque.co.uk/assets/img/img/logo-mosque.svg" alt="Masjid logo" class="img-fluid">
          </div>

          <div class="clock flex-grow-1 d-flex flex-column justify-content-center">
            <div id="clock-time" class="clock-time font-teko">--:--:--</div>
            <div class="clock-sub mt-2">
              <div id="gregorian" class="gregorian">---</div>
              <div id="hijri" class="hijri text-primary fw-bold">---</div>
            </div>
          </div>

          <div class="message-block rounded p-3 mx-auto w-100">
            <div id="message-viewport" class="message-viewport d-flex align-items-center justify-content-center">
              <div id="message-content" class="message-content">Loading message...</div>
            </div>
          </div>

          <footer class="left-foot text-secondary mt-3">Please donate generously to support your Masjid.</footer>
        </div>
      </div>

      <!-- Right Panel -->
      <div class="col-lg-7 d-flex flex-column">
        <div class="panel d-flex flex-column h-100 p-4">
          <div id="prayer-list" class="prayer-list flex-grow-1">
            <!-- Prayer items will be injected here by script -->
          </div>
          <div id="info-row" class="info-row row g-3 mt-auto pt-3">
            <div class="col">
              <div id="sunrise-card" class="info-mini rounded-3 p-3 text-center">
                <div class="time-label fw-bold">Sunrise</div>
                <div id="sunrise-time" class="time font-teko text-primary">--:--</div>
              </div>
            </div>
            <div class="col">
              <div id="zawwal-card" class="info-mini rounded-3 p-3 text-center">
                <div class="time-label fw-bold">Zawwal</div>
                <div id="zawwal-time" class="time font-teko text-primary">--:--</div>
              </div>
            </div>
            <div class="col">
              <div id="sunset-card" class="info-mini rounded-3 p-3 text-center">
                <div class="time-label fw-bold">Sunset</div>
                <div id="sunset-time" class="time font-teko text-primary">--:--</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div id="phone-overlay" class="phone-overlay position-fixed top-0 start-0 w-100 h-100">
    <svg style="width:10vmax; max-width:120px;" class="text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="0.8"><path d="M2 2 L22 22"></path><rect x="4" y="3" width="12" height="18" rx="2"></rect><circle cx="18.5" cy="18.5" r="3" fill="currentColor"></circle></svg>
    <div class="text font-teko">Please Silence Your Phone</div>
    <div id="overlay-clock" class="smalltime font-teko text-secondary">--:--:--</div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDuq7jYQcKDKY3UWNxQwP51fKRwjCERuvo",
    authDomain: "wakefield-central-mosque.firebaseapp.com",
    projectId: "wakefield-central-mosque",
    storageBucket: "wakefield-central-mosque.appspot.com",
    messagingSenderId: "998395111777",
    appId: "1:998395111777:web:5492302e7279822d5cbd20",
    measurementId: "G-NXER4ENDE0"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const ELS = {
    clock: document.getElementById('clock-time'),
    gregorian: document.getElementById('gregorian'),
    hijri: document.getElementById('hijri'),
    messageViewport: document.getElementById('message-viewport'),
    messageContent: document.getElementById('message-content'),
    list: document.getElementById('prayer-list'),
    sunriseTime: document.getElementById('sunrise-time'),
    zawwalTime: document.getElementById('zawwal-time'),
    sunsetTime: document.getElementById('sunset-time'),
    sunriseCard: document.getElementById('sunrise-card'),
    zawwalCard: document.getElementById('zawwal-card'),
    sunsetCard: document.getElementById('sunset-card'),
    logo: document.getElementById('logo-toggle'),
    phoneOverlay: document.getElementById('phone-overlay'),
    overlayClock: document.getElementById('overlay-clock'),
  };

  const HADITHS = [
    "The best of you are those who learn the Qur'an and teach it.",
    "The most beloved deed to Allah is that which is most consistent, even if it is little.",
    "Whoever builds a mosque for Allah, Allah will build for him a house in Paradise.",
    "Charity extinguishes sin as water extinguishes fire.",
    "He who is not grateful to people is not grateful to Allah."
  ];

  let prayerCalendar = {}, jamaatToday = {}, messageText = '';
  let wakeLock = null, ukTime = null;

  const pad = n => String(n).padStart(2,'0');
  const format12NoSuffix = hm => {
    if(!hm || !hm.includes(':')) return '--:--';
    const [h, m] = hm.split(':');
    let hh = parseInt(h, 10);
    hh = hh % 12 || 12;
    return `${hh}:${pad(m)}`;
  }
  const hmToMinutes = hm => hm && hm.includes(':') ? hm.split(':').map(Number).reduce((h, m) => h * 60 + m) : null;
  const minutesToHM = m => m === null || isNaN(m) ? null : `${pad(Math.floor(m / 60) % 24)}:${pad(m % 60)}`;
  
  function saveCache() {
      try {
          localStorage.setItem('masjid_prayerCalendar', JSON.stringify(prayerCalendar));
          localStorage.setItem('masjid_jamaatToday', JSON.stringify(jamaatToday));
          localStorage.setItem('masjid_messageText', messageText);
      } catch (e) { console.warn('Failed to save cache', e); }
  }

  function loadCache() {
      try {
          const calendar = localStorage.getItem('masjid_prayerCalendar');
          const jamaat = localStorage.getItem('masjid_jamaatToday');
          const message = localStorage.getItem('masjid_messageText');
          if(calendar) prayerCalendar = JSON.parse(calendar);
          if(jamaat) jamaatToday = JSON.parse(jamaat);
          if(message) messageText = message;
          return true;
      } catch (e) { return false; }
  }

  function updateClock() {
    if (!ukTime) return;
    ukTime.setSeconds(ukTime.getSeconds() + 1);

    let h = ukTime.getHours();
    const m = pad(ukTime.getMinutes());
    const s = pad(ukTime.getSeconds());
    const h12 = h % 12 || 12;
    const timeString = `${h12}:${m}:${s}`;
    ELS.clock.textContent = timeString;
    ELS.overlayClock.textContent = timeString;
  }

  async function fetchUKTime() {
    try {
        const res = await fetch('http://worldtimeapi.org/api/timezone/Europe/London');
        if (!res.ok) throw new Error('Network response failed');
        const data = await res.json();
        ukTime = new Date(data.datetime);
    } catch (e) {
        console.error("Could not fetch UK time, using local time as fallback.", e);
        if (!ukTime) ukTime = new Date();
    }
  }

  async function fetchHijriDate() {
    if (!ukTime) return;
    try {
      const d=pad(ukTime.getDate()), m=pad(ukTime.getMonth()+1), y=ukTime.getFullYear();
      const res = await fetch(`https://api.aladhan.com/v1/gToH?date=${d}-${m}-${y}`);
      if (!res.ok) return;
      const json = await res.json();
      if (json?.data?.hijri) ELS.hijri.textContent = `${json.data.hijri.day} ${json.data.hijri.month.en} ${json.data.hijri.year}H`;
    } catch (e) { console.warn('Hijri fetch failed', e); }
  }

  function setupListeners() {
    if (!ukTime) return;
    const path = `artifacts/masjid-connect-app/public/data`;
    const d = ukTime, day = pad(d.getDate()), month = pad(d.getMonth() + 1);
    
    onSnapshot(doc(db, `${path}/prayerTimes/today`), s => { if(s.exists()) { jamaatToday = s.data(); saveCache(); renderPrayerList(); } });
    onSnapshot(doc(db, `${path}/prayerCalendar/${day}-${month}`), s => { if(s.exists()) { prayerCalendar = s.data(); saveCache(); renderPrayerList(); } });
    onSnapshot(doc(db, `${path}/message/message`), s => {
      messageText = (s.exists() && s.data().text && String(s.data().text).trim()) ? String(s.data().text).trim() : '';
      saveCache();
      renderMessage();
    });
  }
  
  function renderMessage() {
    const txt = messageText || HADITHS[Math.floor(Math.random() * HADITHS.length)];
    const { messageViewport, messageContent } = ELS;
    if (!messageViewport || !messageContent) return;
    const oldScroller = messageViewport.querySelector('.message-scroller');
    if (oldScroller) { messageViewport.innerHTML = ''; messageViewport.appendChild(messageContent); }
    messageContent.style.animation = '';
    messageContent.textContent = txt;
    requestAnimationFrame(() => {
        const vpH = messageViewport.clientHeight, contentH = messageContent.scrollHeight;
        if (contentH > vpH) {
            const scroller = document.createElement('div'); scroller.className = 'message-scroller';
            const copy1 = messageContent.cloneNode(true), copy2 = messageContent.cloneNode(true);
            copy1.style.marginBottom = '1.5em'; scroller.append(copy1, copy2);
            messageViewport.innerHTML = ''; messageViewport.appendChild(scroller);
            const duration = (contentH / vpH) * 18;
            const styleId = 'marquee-style'; document.getElementById(styleId)?.remove();
            const styleEl = document.createElement('style'); styleEl.id = styleId;
            styleEl.innerHTML = `@keyframes marqueeY { 0% { transform: translateY(0); } 100% { transform: translateY(-${contentH + 24}px); } }`;
            document.head.appendChild(styleEl);
            scroller.style.animation = `marqueeY ${duration}s linear infinite`;
        }
    });
  }

  function renderPrayerList() {
    if (!ELS.list || Object.keys(prayerCalendar).length === 0) return;
    ELS.list.innerHTML = ['Fajr', 'Zuhr', 'Asr', 'Maghrib', 'Isha', 'Jummah'].map(name => {
      const id = `item-${name.toLowerCase()}`;
      if (name === 'Jummah') {
        const j1 = format12NoSuffix(jamaatToday.Jumma), j2 = format12NoSuffix(jamaatToday.Jumma2);
        return `<div class="prayer-item" id="${id}"><div class="prayer-name font-teko">${name}</div><div class="prayer-times row w-100"><div class="col time-block jamaat-time"><div class="time-block-label">1st Jama'at</div><div class="time-block-time font-teko">${j1}</div></div><div class="col time-block jamaat-time"><div class="time-block-label">2nd Jama'at</div><div class="time-block-time font-teko">${j2}</div></div></div></div>`;
      } else {
        const start = format12NoSuffix(prayerCalendar[name]);
        let jamaat;
        if (name === 'Maghrib') {
            const maghribStartMinutes = hmToMinutes(prayerCalendar.Maghrib);
            jamaat = format12NoSuffix(minutesToHM(maghribStartMinutes !== null ? maghribStartMinutes + 1 : null));
        } else {
            jamaat = format12NoSuffix(jamaatToday[name]);
        }
        return `<div class="prayer-item" id="${id}"><div class="prayer-name font-teko">${name}</div><div class="prayer-times row w-100"><div class="col time-block start-time"><div class="time-block-label">Start</div><div class="time-block-time font-teko">${start}</div></div><div class="col time-block jamaat-time"><div class="time-block-label">Jama'at</div><div class="time-block-time font-teko">${jamaat}</div></div></div></div>`;
      }
    }).join('');
    ELS.sunriseTime.textContent = format12NoSuffix(prayerCalendar.Sunrise);
    ELS.zawwalTime.textContent = format12NoSuffix(minutesToHM(hmToMinutes(prayerCalendar.Zuhr) - 15));
    ELS.sunsetTime.textContent = format12NoSuffix(prayerCalendar.Maghrib);
    highlightActive();
  }

  function highlightActive() {
    document.querySelectorAll('.prayer-item.active, .info-mini.active').forEach(el => el.classList.remove('active'));
    if (!ukTime || Object.keys(prayerCalendar).length === 0) return;
    const nowMin = ukTime.getHours() * 60 + ukTime.getMinutes(), isFriday = ukTime.getDay() === 5;
    
    const fajrStart = hmToMinutes(prayerCalendar.Fajr);
    const sunrise = hmToMinutes(prayerCalendar.Sunrise);
    const zuhrStart = hmToMinutes(prayerCalendar.Zuhr);
    const asrStart = hmToMinutes(prayerCalendar.Asr);
    const maghribStart = hmToMinutes(prayerCalendar.Maghrib);
    const ishaStart = hmToMinutes(prayerCalendar.Isha);

    let activePrayer = '';
    
    if (ishaStart !== null && (nowMin >= ishaStart || nowMin < fajrStart)) { activePrayer = 'Isha';
    } else if (maghribStart !== null && ishaStart !== null && nowMin >= maghribStart && nowMin < ishaStart - 1) { activePrayer = 'Maghrib';
    } else if (asrStart !== null && maghribStart !== null && nowMin >= asrStart && nowMin < maghribStart - 15) { activePrayer = 'Asr';
    } else if (zuhrStart !== null && asrStart !== null && nowMin >= zuhrStart && nowMin < asrStart - 1) { activePrayer = isFriday ? 'Jummah' : 'Zuhr';
    } else if (fajrStart !== null && sunrise !== null && nowMin >= fajrStart && nowMin < sunrise) { activePrayer = 'Fajr'; }

    if (activePrayer) document.getElementById(`item-${activePrayer.toLowerCase()}`)?.classList.add('active');
    
    if (sunrise !== null && nowMin >= sunrise && nowMin < sunrise + 15) ELS.sunriseCard.classList.add('active');
    if (zuhrStart !== null && nowMin >= zuhrStart - 15 && nowMin < zuhrStart) ELS.zawwalCard.classList.add('active');
    if (maghribStart !== null && nowMin >= maghribStart - 15 && nowMin < maghribStart) ELS.sunsetCard.classList.add('active');
  }

  function checkPhoneOverlay() {
    if (!ukTime || Object.keys(jamaatToday).length === 0 || Object.keys(prayerCalendar).length === 0) return;
    const nowMin = ukTime.getHours() * 60 + ukTime.getMinutes(), isFriday = ukTime.getDay() === 5;
    const maghribJamaat = hmToMinutes(prayerCalendar.Maghrib) + 1;
    
    let jamaatTimesSource = [jamaatToday.Fajr, jamaatToday.Asr, minutesToHM(maghribJamaat), jamaatToday.Isha];
    if (isFriday) {
        jamaatTimesSource.push(jamaatToday.Jumma, jamaatToday.Jumma2);
    } else {
        jamaatTimesSource.push(jamaatToday.Zuhr);
    }
    
    const jamaatTimes = jamaatTimesSource.map(hmToMinutes).filter(t => t !== null);
    const show = jamaatTimes.some(t => nowMin >= t - 1 && nowMin <= t + 5);
    ELS.phoneOverlay.classList.toggle('visible', show);
  }

  async function toggleWakeLock(shouldBeActive) {
    if (shouldBeActive) {
      if ('wakeLock' in navigator && wakeLock === null) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', () => { wakeLock = null; });
          console.log('Screen Wake Lock is active.');
        } catch (err) { console.error(`Wake Lock failed: ${err.name}, ${err.message}`); }
      }
    } else {
      if (wakeLock !== null) {
        await wakeLock.release();
        wakeLock = null;
      }
    }
  }

  function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(e => console.warn(e));
    } else if (document.exitFullscreen) {
        document.exitFullscreen();
    }
  }
  
  async function initialize() {
    await fetchUKTime();
    
    ELS.gregorian.textContent = ukTime.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    
    if(loadCache()) { renderPrayerList(); renderMessage(); }
    fetchHijriDate();
    setupListeners();
    ELS.logo.addEventListener('click', toggleFullscreen);
    document.addEventListener('fullscreenchange', () => toggleWakeLock(!!document.fullscreenElement));
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && document.fullscreenElement) {
        toggleWakeLock(true);
      }
    });

    updateClock();
    highlightActive();
    
    setInterval(() => {
      updateClock();
      highlightActive();
      checkPhoneOverlay();
    }, 1000);

    setInterval(fetchUKTime, 1000 * 60 * 60); // Resync time every hour
    setInterval(fetchHijriDate, 1000 * 60 * 60);

    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(renderMessage, 250);
    });
  }

  document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>


