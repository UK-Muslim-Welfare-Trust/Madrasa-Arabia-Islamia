<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masjid Prayer Timetable</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Teko:wght@400;600&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* --- Base Styles --- */
        :root {
            --bg-color: #1a202c;
            --card-color: #2d3748;
            --text-color: #edf2f7;
            --primary-color: #4fd1c5;
            --primary-glow: rgba(79, 209, 197, 0.4);
            --secondary-text-color: #a0aec0;
            --border-color: #4a5568;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Poppins', sans-serif;
            overflow: hidden; /* Prevent scrolling on the TV screen */
            padding: 2rem;
        }

        /* --- Animations --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 var(--primary-glow); }
            70% { box-shadow: 0 0 0 12px rgba(79, 209, 197, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 209, 197, 0); }
        }
        
        /* --- Layout --- */
        .main-container {
            display: flex;
            height: calc(100vh - 4rem);
            gap: 2rem;
        }

        .left-panel {
            flex: 4;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            animation: fadeIn 0.8s ease-out forwards;
        }

        .right-panel {
            flex: 6;
            animation: fadeIn 1.2s ease-out forwards;
        }

        .card {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }

        /* --- Left Panel Components --- */
        .header-card {
            align-items: center;
            text-align: center;
        }
        
        .masjid-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 1rem;
        }

        .masjid-name {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 2.5vw;
            margin-bottom: 0.25rem;
        }
        
        .masjid-location {
            font-size: 1.2vw;
            color: var(--secondary-text-color);
        }

        .clock-card {
            text-align: center;
            justify-content: center;
            flex-grow: 1;
        }
        
        #live-clock {
            font-family: 'Teko', sans-serif;
            font-size: 10vw;
            line-height: 1;
            font-weight: 600;
            color: var(--primary-color);
            text-shadow: 0 0 15px var(--primary-glow);
        }

        #gregorian-date, #hijri-date {
            font-size: 1.8vw;
            color: var(--secondary-text-color);
            font-weight: 300;
        }

        .hadith-card {
            justify-content: center;
        }

        .hadith-title {
            font-weight: 600;
            font-size: 1.5vw;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        #hadith-text {
            font-size: 1.1vw;
            font-style: italic;
            color: var(--secondary-text-color);
        }

        /* --- Right Panel (Timetable) --- */
        .timetable-card {
            height: 100%;
        }
        
        .prayer-table {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            border-collapse: separate;
            border-spacing: 0 1rem;
        }
        
        .prayer-table thead th {
            font-size: 1.5vw;
            color: var(--secondary-text-color);
            font-weight: 400;
            text-align: center;
            padding-bottom: 1rem;
        }
        
        .prayer-row {
            transition: all 0.3s ease-in-out;
            border-radius: 0.75rem;
            font-size: 2vw;
            font-weight: 600;
        }

        .prayer-row.highlight {
            background-color: var(--primary-color);
            color: var(--bg-color);
            transform: scale(1.05);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.2), 0 8px 10px -6px rgba(0,0,0,0.2);
            animation: pulse 2s infinite;
        }
        
        .prayer-row td {
            padding: 1rem 1.5rem;
            vertical-align: middle;
            text-align: center;
        }

        .prayer-row td:first-child {
            border-top-left-radius: 0.75rem;
            border-bottom-left-radius: 0.75rem;
            text-align: left;
            font-weight: 700;
        }

        .prayer-row td:last-child {
            border-top-right-radius: 0.75rem;
            border-bottom-right-radius: 0.75rem;
        }

        .extra-info {
            display: flex;
            justify-content: space-around;
            margin-top: auto;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .info-item {
            text-align: center;
            font-size: 1.2vw;
        }
        .info-item .label {
            color: var(--secondary-text-color);
            font-weight: 300;
            font-size: 1vw;
        }
        .info-item .value {
            font-weight: 600;
            font-size: 1.5vw;
        }
        
        /* --- Overlay Message --- */
        #phone-off-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s;
        }
        
        #phone-off-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .overlay-icon {
            width: 10vw;
            height: 10vw;
            margin-bottom: 2rem;
        }

        .overlay-text {
            font-size: 4vw;
            font-weight: 700;
            text-align: center;
            text-shadow: 0 0 10px #000;
        }
        
        .overlay-subtext {
            font-size: 2vw;
            margin-top: 1rem;
            color: var(--secondary-text-color);
        }
        
        /* --- Donation Bar --- */
        .donation-bar {
            background-color: var(--primary-color);
            color: var(--bg-color);
            text-align: center;
            font-weight: 600;
            padding: 0.75rem;
            font-size: 1.2vw;
            border-radius: 0.75rem;
        }
    </style>
</head>
<body>

    <div class="main-container">
        <!-- Left Panel: Clock, Date, Hadith -->
        <div class="left-panel">
            <div class="card header-card">
                 <svg class="masjid-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" color="var(--primary-color)">
                    <path d="M12.74,2.34a1,1,0,0,0-1.48,0l-9,9A1,1,0,0,0,3,13.25V21a1,1,0,0,0,1,1H20a1,1,0,0,0,1-1V13.25a1,1,0,0,0-.26-1.91ZM20,20H16V15a4,4,0,0,0-8,0v5H4V13.41l8-8,8,8Z"></path>
                </svg>
                <h1 class="masjid-name">Wakefield Central Mosque</h1>
                <p class="masjid-location">South Street, WF1 4PG</p>
            </div>
            
            <div class="card clock-card">
                <div id="live-clock">--:--:--</div>
                <div id="gregorian-date">---</div>
                <div id="hijri-date">---</div>
            </div>

            <div class="card hadith-card">
                <h3 class="hadith-title">Hadith of the Day</h3>
                <p id="hadith-text">Loading Hadith...</p>
            </div>

            <div class="donation-bar">
                Please donate generously to support your Masjid's activities.
            </div>
        </div>

        <!-- Right Panel: Prayer Timetable -->
        <div class="right-panel">
            <div class="card timetable-card">
                <table class="prayer-table">
                    <thead>
                        <tr>
                            <th>Prayer</th>
                            <th>Start</th>
                            <th>Jama'at</th>
                        </tr>
                    </thead>
                    <tbody id="prayer-body">
                        <!-- Rows will be injected by JavaScript -->
                    </tbody>
                </table>
                <div class="extra-info">
                    <div class="info-item">
                        <span class="label">Sunrise</span>
                        <span class="value" id="sunrise-time">--:--</span>
                    </div>
                     <div class="info-item">
                        <span class="label">Zawwal</span>
                        <span class="value" id="zawwal-time">--:--</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Jummah 1</span>
                        <span class="value" id="jummah1-time">--:--</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Jummah 2</span>
                        <span class="value" id="jummah2-time">--:--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Phone Off Overlay -->
    <div id="phone-off-overlay">
        <svg class="overlay-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="white">
            <path d="M344 0H168c-17.7 0-32 14.3-32 32v448c0 17.7 14.3 32 32 32h176c17.7 0 32-14.3 32-32V32c0-17.7-14.3-32-32-32zM256 480a32 32 0 1 1 0-64 32 32 0 1 1 0 64zm96-128H160V64h192v288z"/>
            <path d="M502.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-128-128c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L434.7 256 329.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l128-128zM9.4 278.6c-12.5-12.5-12.5-32.8 0-45.3l128-128c12.5-12.5 32.8-12.5 45.3 0s12.5 32.8 0 45.3L77.3 256l105.4 105.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0l-128-128z"/>
        </svg>
        <div class="overlay-text">Please switch off your phone</div>
        <div id="overlay-clock" class="overlay-subtext"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // --- Firebase Configuration (DO NOT EDIT) ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : { apiKey: "AIza...", authDomain: "...", projectId: "..." }; // Fallback config
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'masjid-connect-app';

        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const elements = {
            liveClock: document.getElementById('live-clock'),
            gregorianDate: document.getElementById('gregorian-date'),
            hijriDate: document.getElementById('hijri-date'),
            hadithText: document.getElementById('hadith-text'),
            prayerBody: document.getElementById('prayer-body'),
            sunriseTime: document.getElementById('sunrise-time'),
            zawwalTime: document.getElementById('zawwal-time'),
            jummah1Time: document.getElementById('jummah1-time'),
            jummah2Time: document.getElementById('jummah2-time'),
            phoneOffOverlay: document.getElementById('phone-off-overlay'),
            overlayClock: document.getElementById('overlay-clock'),
        };

        // --- State Variables ---
        let prayerTimesData = {};
        let jamaatTimesData = {};
        const PRAYER_NAMES = ['Fajr', 'Zuhr', 'Asr', 'Maghrib', 'Isha'];

        // --- Utility Functions ---
        const formatTime12h = (timeStr) => {
            if (!timeStr || !timeStr.includes(':')) return '--:--';
            const [hours, minutes] = timeStr.split(':');
            let h = parseInt(hours, 10);
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            return `${String(h).padStart(2, '0')}:${minutes} ${ampm}`;
        };

        const timeToMinutes = (timeStr) => {
            if (!timeStr || !timeStr.includes(':')) return null;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        };
        
        const minutesToTime24h = (minutes) => {
            if (minutes === null || isNaN(minutes)) return null;
            const h = Math.floor(minutes / 60) % 24;
            const m = minutes % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        };


        // --- Data Fetching ---
        const fetchHijriDate = async () => {
             try {
                const today = new Date();
                const d = String(today.getDate()).padStart(2, '0');
                const m = String(today.getMonth() + 1).padStart(2, '0');
                const y = today.getFullYear();
                const response = await fetch(`https://api.aladhan.com/v1/gToH?date=${d}-${m}-${y}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                if (data.code === 200 && data.data.hijri) {
                    const hijri = data.data.hijri;
                    elements.hijriDate.textContent = `${hijri.day} ${hijri.month.en} ${hijri.year}H`;
                } else {
                    throw new Error('Invalid API response for Hijri date');
                }
            } catch (error) {
                console.error("Could not fetch Hijri date:", error);
                elements.hijriDate.textContent = 'Could not load Hijri date';
            }
        };
        
        const fetchHadith = async () => {
             try {
                const response = await fetch('https://random-hadith-generator.vercel.app/bukhari/');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                elements.hadithText.textContent = `"${data.data.hadith_english}" - (Sahih al-Bukhari ${data.data.refno})`;
            } catch (error) {
                console.error("Could not fetch Hadith:", error);
                elements.hadithText.textContent = 'The best of you are those who are best to their families. (Tirmidhi)';
            }
        };

        const setupPrayerTimeListeners = () => {
            const firestorePath = `artifacts/${appId}/public/data`;
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const calendarDocId = `${day}-${month}`;

            // Listener for Jamaat Times
            const jamaatRef = doc(db, `${firestorePath}/prayerTimes/today`);
            onSnapshot(jamaatRef, (doc) => {
                if (doc.exists()) {
                    jamaatTimesData = doc.data();
                    updateUI();
                } else {
                    console.error("Jamaat times document does not exist.");
                }
            });

            // Listener for Start Times (from calendar)
            const calendarRef = doc(db, `${firestorePath}/prayerCalendar/${calendarDocId}`);
            onSnapshot(calendarRef, (doc) => {
                if (doc.exists()) {
                    prayerTimesData = doc.data();
                    updateUI();
                } else {
                    console.error("Today's prayer calendar document does not exist.");
                }
            });
        };
        
        // --- UI Update Logic ---
        const updateUI = () => {
            if (!prayerTimesData.Fajr || !jamaatTimesData.Fajr) {
                console.log("Waiting for data to be loaded...");
                return;
            }
            
            // Populate Table
            elements.prayerBody.innerHTML = ''; // Clear existing rows
            PRAYER_NAMES.forEach(prayer => {
                const start = formatTime12h(prayerTimesData[prayer]);
                const jamaat = formatTime12h(jamaatTimesData[prayer]);
                const row = document.createElement('tr');
                row.classList.add('prayer-row');
                row.id = `row-${prayer.toLowerCase()}`;
                row.innerHTML = `<td>${prayer}</td><td>${start}</td><td>${jamaat}</td>`;
                elements.prayerBody.appendChild(row);
            });

            // Populate Extra Info
            elements.sunriseTime.textContent = formatTime12h(prayerTimesData.Sunrise);
            const zuhrStartMinutes = timeToMinutes(prayerTimesData.Zuhr);
            const zawwalTime = minutesToTime24h(zuhrStartMinutes - 10);
            elements.zawwalTime.textContent = formatTime12h(zawwalTime);

            elements.jummah1Time.textContent = formatTime12h(jamaatTimesData.Jumma);
            elements.jummah2Time.textContent = formatTime12h(jamaatTimesData.Jumma2);
        };
        
        const highlightCurrentPrayer = () => {
            const now = new Date();
            const nowMinutes = now.getHours() * 60 + now.getMinutes();

            let currentPrayer = '';
            
            const times = PRAYER_NAMES.map(p => ({ name: p, start: timeToMinutes(prayerTimesData[p]) })).filter(p => p.start !== null);
            times.sort((a, b) => a.start - b.start);

            // Logic to find current prayer
            if (nowMinutes >= times[times.length - 1].start) {
                currentPrayer = times[times.length - 1].name;
            } else {
                 for (let i = 0; i < times.length - 1; i++) {
                    if (nowMinutes >= times[i].start && nowMinutes < times[i + 1].start) {
                        currentPrayer = times[i].name;
                        break;
                    }
                }
            }
            // Before first prayer (Fajr), it's still Isha time
            if (!currentPrayer && times.length > 0) {
                 currentPrayer = times[times.length - 1].name;
            }


            document.querySelectorAll('.prayer-row').forEach(row => row.classList.remove('highlight'));
            if (currentPrayer) {
                const currentPrayerRow = document.getElementById(`row-${currentPrayer.toLowerCase()}`);
                if (currentPrayerRow) {
                    currentPrayerRow.classList.add('highlight');
                }
            }
        };

        const checkPhoneOffMessage = () => {
            const now = new Date();
            const nowMinutes = now.getHours() * 60 + now.getMinutes();
            let showOverlay = false;
            
            const jamaatTimes = [
                jamaatTimesData.Fajr, jamaatTimesData.Zuhr, jamaatTimesData.Asr, 
                jamaatTimesData.Maghrib, jamaatTimesData.Isha,
                jamaatTimesData.Jumma, jamaatTimesData.Jumma2
            ].map(timeToMinutes).filter(t => t !== null);

            for (const jamaat of jamaatTimes) {
                const before = jamaat - 1;
                const after = jamaat + 5;
                if (nowMinutes >= before && nowMinutes <= after) {
                    showOverlay = true;
                    break;
                }
            }

            if (showOverlay) {
                elements.phoneOffOverlay.classList.add('visible');
            } else {
                elements.phoneOffOverlay.classList.remove('visible');
            }
        };

        // --- Main Loop ---
        const tick = () => {
            const now = new Date();
            
            // Update Clock
            elements.liveClock.textContent = now.toLocaleTimeString('en-US', { hour12: false });
            elements.overlayClock.textContent = now.toLocaleTimeString('en-GB');

            // Update Date (only once per day, but checking every minute is fine)
            if(now.getSeconds() === 0){
                elements.gregorianDate.textContent = now.toLocaleDateString('en-GB', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
            }
            
            // Update prayer highlight and overlay (every second is responsive)
            if (Object.keys(prayerTimesData).length > 0) {
                 highlightCurrentPrayer();
                 checkPhoneOffMessage();
            }
        };

        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial date setup
            const now = new Date();
             elements.gregorianDate.textContent = now.toLocaleDateString('en-GB', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            // Fetch initial data
            fetchHijriDate();
            fetchHadith();
            setupPrayerTimeListeners();
            
            // Start the clock and main loop
            setInterval(tick, 1000);
            
            // Fetch a new Hadith daily
            setInterval(fetchHadith, 24 * 60 * 60 * 1000);
        });

    </script>
</body>
</html>

