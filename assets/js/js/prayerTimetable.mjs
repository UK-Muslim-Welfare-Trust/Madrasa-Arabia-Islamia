import{db as t}from"./firebase-init.mjs";import{doc as e,onSnapshot as a,getDoc as n,collection as r,getDocs as o}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";import s from"https://esm.sh/jspdf@2.5.1";import i from"https://esm.sh/jspdf-autotable@3.8.2";const d="artifacts/masjid-connect-app/public/data";let l=null;const c=t=>{if(!t||!t.includes(":"))return"--:--";const[e,a]=t.split(":");let n=parseInt(e,10);const r=n>=12?"PM":"AM";return n=n%12||12,`${n}:${a} ${r}`},m=(t,e)=>{if(!t||!t.includes(":"))return null;const[a,n]=t.split(":").map(Number),r=60*a+n-e;if(r<0)return null;const o=Math.floor(r/60)%24,s=r%60;return c(`${String(o).padStart(2,"0")}:${String(s).padStart(2,"0")}`)},u=(t,e)=>{const a="N/A";document.getElementById("pt-fajr-start").textContent=c(e.Fajr)||a,document.getElementById("pt-fajr-jamaat").textContent=c(t.Fajr)||a,document.getElementById("pt-fajr-end").textContent=c(e.Sunrise)||a,document.getElementById("pt-zuhr-start").textContent=c(e.Zuhr)||a,document.getElementById("pt-zuhr-jamaat").textContent=c(t.Zuhr)||a,document.getElementById("pt-zuhr-end").textContent=m(e.Asr,1)||a,document.getElementById("pt-jummah-jamaat").textContent=c(t.Jumma)||a,document.getElementById("pt-jummah-2nd").textContent=c(t.Jumma2)||"",document.getElementById("pt-asr-start").textContent=c(e.Asr)||a,document.getElementById("pt-asr-jamaat").textContent=c(t.Asr)||a,document.getElementById("pt-asr-end").textContent=m(e.Maghrib,15)||a,document.getElementById("pt-maghrib-start").textContent=c(e.Maghrib)||a,document.getElementById("pt-maghrib-jamaat").textContent=c(e.Maghrib)||a,document.getElementById("pt-maghrib-end").textContent=m(e.Isha,1)||a,document.getElementById("pt-isha-start").textContent=c(e.Isha)||a,document.getElementById("pt-isha-jamaat").textContent=c(t.Isha)||a,document.getElementById("pt-isha-end").textContent=m(e.Fajr,1)||a},g=async()=>{const e=document.getElementById("monthSelect").value,a=document.getElementById("pdf-generating-spinner");a.classList.remove("d-none");try{const n=await(async()=>{if(l)return console.log("Using cached prayer calendar."),l;try{console.log("Fetching full prayer calendar from Firestore...");const e=r(t,`${d}/prayerCalendar`),a=(await o(e)).docs.map((t=>({id:t.id,...t.data()})));return a.sort(((t,e)=>{const[a,n]=t.id.split("-").map(Number),[r,o]=e.id.split("-").map(Number);return n!==o?n-o:a-r})),l=a,console.log("Full prayer calendar fetched and cached."),l}catch(t){return console.error("Failed to fetch full prayer calendar:",t),[]}})();if(0===n.length)throw new Error("Calendar data is not available to generate PDF.");const m=new s,u=(new Date).getFullYear(),g="all"===e?"Full Year":new Date(u,e,1).toLocaleString("default",{month:"long"});let h="all"===e?n:n.filter((t=>parseInt(t.id.split("-")[1],10)===parseInt(e,10)+1));const p=[["Date","Fajr","Sunrise","Zuhr","Asr","Maghrib","Isha"]],y=h.map((t=>[t.id.replace("-","/"),c(t.Fajr),c(t.Sunrise),c(t.Zuhr),c(t.Asr),c(t.Maghrib),c(t.Isha)]));i(m,{head:p,body:y,startY:50,didDrawPage:t=>{m.setFontSize(16).setFont(void 0,"bold"),m.text("Wakefield Central Mosque & Madrasa Arabia Islamia",m.internal.pageSize.getWidth()/2,20,{align:"center"}),m.setFontSize(10).setFont(void 0,"normal"),m.text("South Street, West Yorkshire, WF1 4PG",m.internal.pageSize.getWidth()/2,28,{align:"center"}),m.text("Phone: 07397 054519 | Email: info@wakefieldcentralmosque.co.uk",m.internal.pageSize.getWidth()/2,34,{align:"center"}),m.setFontSize(12),m.text(`Prayer Calendar - ${g} ${u}`,m.internal.pageSize.getWidth()/2,42,{align:"center"}),m.setFontSize(9),m.text("Support your Masjid: Donations can be made via our website, cheque, direct debit, or using the money boxes available at the Masjid.",15,m.internal.pageSize.getHeight()-15)},margin:{top:30,bottom:25}}),m.save(`WCM_Prayer_Calendar_${g}.pdf`)}catch(t){console.error("Error generating PDF:",t),alert("Could not generate the PDF. Please check the console for errors.")}finally{a.classList.add("d-none")}};document.addEventListener("DOMContentLoaded",(()=>{(async()=>{const t=document.getElementById("dateTodayC"),e=document.getElementById("dateTodayI");if(t&&(t.textContent=(new Date).toLocaleDateString("en-GB",{year:"numeric",month:"short",day:"numeric"})),e)try{const t=new Date,a=await fetch(`https://api.aladhan.com/v1/gToH?date=${String(t.getDate()).padStart(2,"0")}-${String(t.getMonth()+1).padStart(2,"0")}-${t.getFullYear()}`);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const n=await a.json();if(200!==n.code||!n.data.hijri)throw new Error("Invalid response from Hijri API.");{const t=n.data.hijri;e.textContent=`${t.day} ${t.month.en} ${t.year}`}}catch(t){console.error("Could not fetch Hijri date:",t),e.textContent="Could not load Hijri date"}})(),(async()=>{const t=document.getElementById("zawaal-time");if(t)try{console.log("Fetching Zawaal time...");const e=await fetch("https://api.aladhan.com/v1/timingsByCity?city=Wakefield&country=United%20Kingdom&method=2");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const a=await e.json();200===a.code&&a.data.timings&&a.data.timings.Dhuhr?(t.textContent=c(a.data.timings.Dhuhr),console.log("Zawaal time fetched successfully.")):(t.textContent="N/A",console.warn("Could not retrieve Zawaal time from API response."))}catch(e){console.error("Could not fetch Zawaal time:",e),t.textContent="Error"}})(),(async()=>{const r=new Date,o=`${String(r.getDate()).padStart(2,"0")}-${String(r.getMonth()+1).padStart(2,"0")}`,s=e(t,`${d}/prayerCalendar/${o}`);let i={};try{console.log(`Fetching today's prayer start/end times for ${o}...`);const t=await n(s);t.exists()?(i=t.data(),console.log("Prayer start/end times fetched successfully:",i)):console.error("Could not find today's entry in the prayer calendar.")}catch(t){console.error("Error fetching prayer calendar for today:",t)}const l=e(t,`${d}/prayerTimes/today`);a(l,(t=>{const e=t.exists()?t.data():{};console.log("Received Jama'ah times update:",e),u(e,i)}))})();const r=document.getElementById("generatePdfBtn");r&&r.addEventListener("click",g)}));