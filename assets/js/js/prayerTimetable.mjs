import{db as t}from"./firebase-init.mjs";import{doc as e,onSnapshot as n,getDoc as a,collection as r,getDocs as o}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";import i from"https://esm.sh/jspdf@2.5.1";import d from"https://esm.sh/jspdf-autotable@3.8.2";const s="artifacts/masjid-connect-app/public/data";let l=null;const c=t=>{if(!t||!t.includes(":"))return"--:--";const[e,n]=t.split(":");let a=parseInt(e,10);const r=a>=12?"PM":"AM";return a=a%12||12,`${a}:${n} ${r}`},m=(t,e)=>{if(!t||!t.includes(":"))return null;const[n,a]=t.split(":").map(Number),r=60*n+a-e;if(r<0)return null;const o=Math.floor(r/60)%24,i=r%60;return c(`${String(o).padStart(2,"0")}:${String(i).padStart(2,"0")}`)},u=async()=>{const e=document.getElementById("monthSelect").value,n=document.getElementById("pdf-generating-spinner");n.classList.remove("d-none");try{const a=await(async()=>{if(l)return l;try{const e=r(t,`${s}/prayerCalendar`),n=(await o(e)).docs.map((t=>({id:t.id,...t.data()})));return n.sort(((t,e)=>{const[n,a]=t.id.split("-").map(Number),[r,o]=e.id.split("-").map(Number);return a!==o?a-o:n-r})),l=n,l}catch(t){return console.error("Failed to fetch full prayer calendar:",t),[]}})();if(0===a.length)throw new Error("Calendar data is not available to generate PDF.");const m=new i,u=(new Date).getFullYear(),h="all"===e?"Full Year":new Date(u,e,1).toLocaleString("default",{month:"long"});let g="all"===e?a:a.filter((t=>parseInt(t.id.split("-")[1],10)===parseInt(e,10)+1));const p=[["Date","Fajr","Sunrise","Zuhr","Asr","Maghrib","Isha"]],y=g.map((t=>[t.id.replace("-","/"),c(t.Fajr),c(t.Sunrise),c(t.Zuhr),c(t.Asr),c(t.Maghrib),c(t.Isha)]));d(m,{head:p,body:y,startY:50,didDrawPage:t=>{m.setFontSize(16).setFont(void 0,"bold").text("Wakefield Central Mosque & Madrasa Arabia Islamia",m.internal.pageSize.getWidth()/2,20,{align:"center"}),m.setFontSize(10).setFont(void 0,"normal").text("South Street, West Yorkshire, WF1 4PG",m.internal.pageSize.getWidth()/2,28,{align:"center"}),m.text("Phone: 07397 054519 | Email: info@wakefieldcentralmosque.co.uk",m.internal.pageSize.getWidth()/2,34,{align:"center"}),m.setFontSize(12).text(`Prayer Calendar - ${h} ${u}`,m.internal.pageSize.getWidth()/2,42,{align:"center"}),m.setFontSize(9).text("Support your Masjid: Donations can be made via our website, cheque, direct debit, or using the money boxes available at the Masjid.",15,m.internal.pageSize.getHeight()-15)},margin:{top:30,bottom:25}}),m.save(`WCM_Prayer_Calendar_${h}.pdf`)}catch(t){console.error("Error generating PDF:",t),alert("Could not generate the PDF. Please check the console for errors.")}finally{n.classList.add("d-none")}},h=async()=>{const r=new Date,o=`${String(r.getDate()).padStart(2,"0")}-${String(r.getMonth()+1).padStart(2,"0")}`,i=e(t,`${s}/prayerCalendar/${o}`);let d={};try{const t=await a(i);t.exists()?d=t.data():console.error("Could not find today's entry in the prayer calendar.")}catch(t){console.error("Error fetching prayer calendar for today:",t)}const l=e(t,`${s}/prayerTimes/today`);n(l,(t=>{((t,e)=>{const n="N/A";document.getElementById("pt-fajr-start").textContent=c(e.Fajr)||n,document.getElementById("pt-fajr-jamaat").textContent=c(t.Fajr)||n,document.getElementById("pt-fajr-end").textContent=c(e.Sunrise)||n,document.getElementById("pt-zuhr-start").textContent=c(e.Zuhr)||n,document.getElementById("pt-zuhr-jamaat").textContent=c(t.Zuhr)||n,document.getElementById("pt-zuhr-end").textContent=m(e.Asr,1)||n,document.getElementById("pt-jummah-jamaat").textContent=c(t.Jumma)||n,document.getElementById("pt-jummah-2nd").textContent=c(t.Jumma2)||"",document.getElementById("pt-asr-start").textContent=c(e.Asr)||n,document.getElementById("pt-asr-jamaat").textContent=c(t.Asr)||n,document.getElementById("pt-asr-end").textContent=m(e.Maghrib,15)||n,document.getElementById("pt-maghrib-start").textContent=c(e.Maghrib)||n,document.getElementById("pt-maghrib-jamaat").textContent=c(e.Maghrib)||n,document.getElementById("pt-maghrib-end").textContent=m(e.Isha,1)||n,document.getElementById("pt-isha-start").textContent=c(e.Isha)||n,document.getElementById("pt-isha-jamaat").textContent=c(t.Isha)||n,document.getElementById("pt-isha-end").textContent=m(e.Fajr,1)||n})(t.exists()?t.data():{},d)}))};document.addEventListener("DOMContentLoaded",(()=>{(async()=>{const t=document.getElementById("dateTodayC"),e=document.getElementById("dateTodayI");if(t&&(t.textContent=(new Date).toLocaleDateString("en-GB",{year:"numeric",month:"short",day:"numeric"})),e)try{const t=new Date,n=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),r=t.getFullYear(),o=await fetch(`https://api.aladhan.com/v1/gToH?date=${n}-${a}-${r}`);if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const i=await o.json();if(200!==i.code||!i.data.hijri)throw new Error("Invalid response from Hijri API.");{const t=i.data.hijri;e.textContent=`${t.day} ${t.month.en} ${t.year}`}}catch(t){console.error("Could not fetch Hijri date:",t),e.textContent="Could not load Hijri date"}})(),(async()=>{const t=document.getElementById("zawaal-time");if(t)try{const e=await fetch("https://api.aladhan.com/v1/timingsByCity?city=Wakefield&country=United%20Kingdom&method=2");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=await e.json();200===n.code&&n.data.timings&&n.data.timings.Dhuhr?t.textContent=c(n.data.timings.Dhuhr):t.textContent="N/A"}catch(e){console.error("Could not fetch Zawaal time:",e),t.textContent="Error"}})(),h();const t=document.getElementById("generatePdfBtn");t&&t.addEventListener("click",u)}));