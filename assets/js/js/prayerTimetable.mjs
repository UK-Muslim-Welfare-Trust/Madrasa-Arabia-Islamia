import{doc as t,onSnapshot as e,getDoc as n,collection as a,getDocs as o}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";import r from"https://esm.sh/jspdf@2.5.1";import i from"https://esm.sh/jspdf-autotable@3.8.2";const s="masjid-connect-app",d=document.getElementById("dateTodayC"),c=document.getElementById("dateTodayI");function l(t){if(!t||!t.includes(":"))return t||"--:--";const[e,n]=t.split(":");let a=parseInt(e,10);const o=a>=12?"PM":"AM";return a=a%12||12,`${a}:${n} ${o}`}function m(t,e){const n=function(t){if(!t||!t.includes(":"))return null;const[e,n]=t.split(":").map(Number);return 60*e+n}(t);if(null===n)return null;return function(t){if(null===t)return"--:--";const e=Math.floor(t/60)%24;let n=e%12;return n=n||12,`${n}:${String(t%60).padStart(2,"0")} ${e>=12?"PM":"AM"}`}(n-e)}async function u(a){const o=new Date,r=`${String(o.getDate()).padStart(2,"0")}-${String(o.getMonth()+1).padStart(2,"0")}`,i=t(a,`/artifacts/${s}/public/data/prayerCalendar/${r}`);let d={};try{const t=await n(i);t.exists()?d=t.data():console.warn(`Prayer calendar document does not exist for today: ${r}`)}catch(t){console.error("Error fetching prayer calendar:",t)}const c=t(a,`/artifacts/${s}/public/data/prayerTimes/today`);e(c,(t=>{let e={};t.exists()?e=t.data():console.warn("Prayer times (Jamaat) document does not exist."),function(t,e){const n="N/A";document.getElementById("pt-fajr-start").textContent=l(e.Fajr)||n,document.getElementById("pt-fajr-jamaat").textContent=l(t.Fajr)||n,document.getElementById("pt-fajr-end").textContent=l(e.Sunrise)||n;const a=l(e.Zuhr)||n,o=m(e.Asr,1)||n;document.getElementById("pt-zuhr-start").textContent=a,document.getElementById("pt-zuhr-jamaat").textContent=l(t.Zuhr)||n,document.getElementById("pt-zuhr-end").textContent=o,document.getElementById("pt-jummah-jamaat").textContent=l(t.Jumma)||n,document.getElementById("pt-asr-start").textContent=l(e.Asr)||n,document.getElementById("pt-asr-jamaat").textContent=l(t.Asr)||n,document.getElementById("pt-asr-end").textContent=m(e.Maghrib,15)||n,document.getElementById("pt-maghrib-start").textContent=l(e.Maghrib)||n,document.getElementById("pt-maghrib-jamaat").textContent=l(e.Maghrib)||n,document.getElementById("pt-maghrib-end").textContent=m(e.Isha,1)||n,document.getElementById("pt-isha-start").textContent=l(e.Isha)||n,document.getElementById("pt-isha-jamaat").textContent=l(t.Isha)||n,document.getElementById("pt-isha-end").textContent=m(e.Fajr,1)||n,t.Jumma2&&(document.getElementById("pt-jummah-2nd").textContent=l(t.Jumma2))}(e,d)}),(t=>{console.error("Error listening to prayer times:",t)}))}let g=null;async function h(t,e){const n=document.getElementById("pdf-generating-spinner");n.classList.remove("d-none");try{const d=await async function(t){if(g)return g;const e=`/artifacts/${s}/public/data/prayerCalendar`,n=await o(a(t,e)),r=[];return n.forEach((t=>{r.push({id:t.id,...t.data()})})),r.sort(((t,e)=>{const[n,a]=t.id.split("-").map(Number),[o,r]=e.id.split("-").map(Number);return a!==r?a-r:n-o})),g=r,g}(t),c=new r;let m=d;const u=(new Date).getFullYear(),h="all"!==e?new Date(u,e,1).toLocaleString("default",{month:"long"}):"Full Year";if("all"!==e){const t=parseInt(e,10)+1;m=d.filter((e=>{const[,n]=e.id.split("-").map(Number);return n===t}))}const p=["Date","Fajr","Sunrise","Zuhr","Asr","Maghrib","Isha"],f=m.map((t=>[t.id.replace("-","/"),l(t.Fajr),l(t.Sunrise),l(t.Zuhr),l(t.Asr),l(t.Maghrib),l(t.Isha)]));let y=null;try{const t=await fetch("/img/qr-donate.svg"),e=await t.text();y=await async function(t,e=150,n=150){return new Promise(((a,o)=>{const r=new Image,i=new Blob([t],{type:"image/svg+xml;charset=utf-8"}),s=URL.createObjectURL(i);r.onload=()=>{const t=document.createElement("canvas");t.width=e,t.height=n,t.getContext("2d").drawImage(r,0,0,e,n);const o=t.toDataURL("image/png");URL.revokeObjectURL(s),a(o)},r.onerror=t=>{URL.revokeObjectURL(s),o(t)},r.src=s}))}(e)}catch(t){console.error("Could not load and convert QR code image.",t)}i(c,{head:[p],body:f,startY:50,styles:{fontSize:7.8,cellPadding:1.4},headStyles:{fontSize:9,fillColor:[33,37,41]},didDrawPage:function(t){c.setFontSize(16),c.setFont(void 0,"bold"),c.text("Wakefield Central Mosque & Madrasa Arabia Islamia",c.internal.pageSize.getWidth()/2,20,{align:"center"}),c.setFontSize(10),c.setFont(void 0,"normal"),c.text("South Street, West Yorkshire, WF1 4PG",c.internal.pageSize.getWidth()/2,28,{align:"center"}),c.setFontSize(10),c.setFont(void 0,"normal"),c.text("Phone: 07397 054519 | Email: info@wakefieldcentralmosque.co.uk",c.internal.pageSize.getWidth()/2,34,{align:"center"}),c.setFontSize(12),c.text(`Prayer Calendar - ${h} ${u}`,c.internal.pageSize.getWidth()/2,42,{align:"center"});const e=c.internal.pageSize.getHeight();y&&c.addImage(y,"PNG",15,e-45,30,30),c.setFontSize(9);c.text(["Support your Masjid: Donations can be made via our website, cheque, direct debit,","or using the money boxes available at the Masjid."],50,e-32)},margin:{top:30,bottom:48}}),c.save(`WCM_Prayer_Calendar_${h}.pdf`)}catch(t){console.error("Error generating PDF:",t),alert("Could not generate the PDF. Please check the console for errors.")}finally{n.classList.add("d-none")}}document.addEventListener("DOMContentLoaded",(function(){!function(){if(!d)return;const t=new Date;d.textContent=t.toLocaleDateString("en-GB",{year:"numeric",month:"short",day:"numeric"})}(),async function(){if(c)try{const t=new Date,e=String(t.getDate()).padStart(2,"0"),n=String(t.getMonth()+1).padStart(2,"0"),a=t.getFullYear(),o=await fetch(`https://api.aladhan.com/v1/gToH?date=${e}-${n}-${a}`);if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const r=await o.json();if(200===r.code&&r.data.hijri){const t=r.data.hijri;c.textContent=`${t.day} ${t.month.en} ${t.year}`}else c.textContent="Hijri date unavailable"}catch(t){console.error("Could not fetch Hijri date:",t),c.textContent="Could not load Hijri date"}}(),async function(){const t=document.getElementById("zawaal-time");if(t)try{const e=await fetch("https://api.aladhan.com/v1/timingsByCity?city=Wakefield&country=United%20Kingdom&method=2");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=await e.json();if(200===n.code&&n.data.timings&&n.data.timings.Dhuhr){const e=n.data.timings.Dhuhr;t.textContent=l(e)}else t.textContent="N/A"}catch(e){console.error("Could not fetch Zawaal time:",e),t.textContent="Error"}}();const t=setInterval((()=>{if(void 0!==window.firebaseDb){clearInterval(t);const e=window.firebaseDb;u(e),document.getElementById("generatePdfBtn").addEventListener("click",(()=>{const t=document.getElementById("monthSelect").value;h(e,t)}))}}),100)}));