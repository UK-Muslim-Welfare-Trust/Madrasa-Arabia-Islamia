import{db as t}from"./firebase-init.mjs";import{doc as e,onSnapshot as n,getDoc as a,collection as r,getDocs as o}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";import i from"https://esm.sh/jspdf@2.5.1";import d from"https://esm.sh/jspdf-autotable@3.8.2";const s="masjid-connect-app";let c=null;function l(t){if(!t||!t.includes(":"))return t||"--:--";const[e,n]=t.split(":");let a=parseInt(e,10);const r=a>=12?"PM":"AM";return a%=12,a=a||12,`${a}:${n} ${r}`}function m(t,e){if(!t||!t.includes(":"))return null;const[n,a]=t.split(":").map(Number),r=60*n+a-e;if(r<0)return null;const o=Math.floor(r/60)%24,i=r%60;return l(`${String(o).padStart(2,"0")}:${String(i).padStart(2,"0")}`)}async function u(){const e=document.getElementById("monthSelect").value,n=document.getElementById("pdf-generating-spinner");n.classList.remove("d-none");try{const a=await async function(){if(c)return c;const e=r(t,`/artifacts/${s}/public/data/prayerCalendar`),n=(await o(e)).docs.map((t=>({id:t.id,...t.data()})));return n.sort(((t,e)=>{const[n,a]=t.id.split("-").map(Number),[r,o]=e.id.split("-").map(Number);return a!==o?a-o:n-r})),c=n,n}();!function(t,e){const n=new i,a=(new Date).getFullYear(),r="all"===e?"Full Year":new Date(a,e,1).toLocaleString("default",{month:"long"});let o="all"!==e?t.filter((t=>parseInt(t.id.split("-")[1],10)===parseInt(e,10)+1)):t;const s=[["Date","Fajr","Sunrise","Zuhr","Asr","Maghrib","Isha"]],c=o.map((t=>[t.id.replace("-","/"),l(t.Fajr),l(t.Sunrise),l(t.Zuhr),l(t.Asr),l(t.Maghrib),l(t.Isha)]));d(n,{head:s,body:c,startY:50,didDrawPage:t=>{n.setFontSize(16).setFont(void 0,"bold").text("Wakefield Central Mosque & Madrasa Arabia Islamia",n.internal.pageSize.getWidth()/2,20,{align:"center"}),n.setFontSize(10).setFont(void 0,"normal").text("South Street, West Yorkshire, WF1 4PG",n.internal.pageSize.getWidth()/2,28,{align:"center"}),n.text("Phone: 07397 054519 | Email: info@wakefieldcentralmosque.co.uk",n.internal.pageSize.getWidth()/2,34,{align:"center"}),n.setFontSize(12).text(`Prayer Calendar - ${r} ${a}`,n.internal.pageSize.getWidth()/2,42,{align:"center"}),n.setFontSize(9).text("Support your Masjid: Donations can be made via our website, cheque, direct debit, or using the money boxes available at the Masjid.",15,n.internal.pageSize.getHeight()-15)},margin:{top:30,bottom:25}}),n.save(`WCM_Prayer_Calendar_${r}.pdf`)}(a,e)}catch(t){console.error("Error generating PDF:",t),alert("Could not generate the PDF. Please check the console for errors.")}finally{n.classList.add("d-none")}}document.addEventListener("DOMContentLoaded",(()=>{!async function(){const t=document.getElementById("dateTodayC"),e=document.getElementById("dateTodayI");t&&(t.textContent=(new Date).toLocaleDateString("en-GB",{year:"numeric",month:"short",day:"numeric"}));if(e)try{const t=new Date,n=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),r=t.getFullYear(),o=await fetch(`https://api.aladhan.com/v1/gToH?date=${n}-${a}-${r}`);if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const i=await o.json();e.textContent=200===i.code&&i.data.hijri?`${i.data.hijri.day} ${i.data.hijri.month.en} ${i.data.hijri.year}`:"Hijri date unavailable"}catch(t){console.error("Could not fetch Hijri date:",t),e.textContent="Could not load Hijri date"}}(),async function(){const t=document.getElementById("zawaal-time");if(t)try{const e=await fetch("https://api.aladhan.com/v1/timingsByCity?city=Wakefield&country=United%20Kingdom&method=2");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=await e.json();t.textContent=200===n.code&&n.data.timings&&n.data.timings.Dhuhr?l(n.data.timings.Dhuhr):"N/A"}catch(e){console.error("Could not fetch Zawaal time:",e),t.textContent="Error"}}(),async function(){const r=new Date,o=`${String(r.getDate()).padStart(2,"0")}-${String(r.getMonth()+1).padStart(2,"0")}`,i=e(t,`/artifacts/${s}/public/data/prayerCalendar/${o}`);let d={};try{const t=await a(i);d=t.exists()?t.data():{}}catch(t){console.error("Error fetching prayer calendar:",t)}const c=e(t,`/artifacts/${s}/public/data/prayerTimes/today`);n(c,(t=>{!function(t,e){const n="N/A";document.getElementById("pt-fajr-start").textContent=l(e.Fajr)||n,document.getElementById("pt-fajr-jamaat").textContent=l(t.Fajr)||n,document.getElementById("pt-fajr-end").textContent=l(e.Sunrise)||n,document.getElementById("pt-zuhr-start").textContent=l(e.Zuhr)||n,document.getElementById("pt-zuhr-jamaat").textContent=l(t.Zuhr)||n,document.getElementById("pt-zuhr-end").textContent=m(e.Asr,1)||n,document.getElementById("pt-jummah-jamaat").textContent=l(t.Jumma)||n,document.getElementById("pt-jummah-2nd").textContent=l(t.Jumma2)||"",document.getElementById("pt-asr-start").textContent=l(e.Asr)||n,document.getElementById("pt-asr-jamaat").textContent=l(t.Asr)||n,document.getElementById("pt-asr-end").textContent=m(e.Maghrib,15)||n,document.getElementById("pt-maghrib-start").textContent=l(e.Maghrib)||n,document.getElementById("pt-maghrib-jamaat").textContent=l(e.Maghrib)||n,document.getElementById("pt-maghrib-end").textContent=m(e.Isha,1)||n,document.getElementById("pt-isha-start").textContent=l(e.Isha)||n,document.getElementById("pt-isha-jamaat").textContent=l(t.Isha)||n,document.getElementById("pt-isha-end").textContent=m(e.Fajr,1)||n}(t.exists()?t.data():{},d)}))}();const r=document.getElementById("generatePdfBtn");r&&r.addEventListener("click",u)}));