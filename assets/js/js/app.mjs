import{subscribeToTopic as e,unsubscribeFromTopic as t,fetchAndScheduleJamaatReminders as n}from"./notifications.mjs";import{initializeApp as a}from"./firebase-init.mjs";let o=null;function i(){const e=document.getElementById("install-button");e&&(e.style.display="none",/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream?(e.style.display="block",e.addEventListener("click",(()=>{alert('To install, tap the Share button, then scroll down and tap "Add to Home Screen".')}))):(window.addEventListener("beforeinstallprompt",(t=>{t.preventDefault(),o=t,e.style.display="block"})),e.addEventListener("click",(async()=>{o&&(o.prompt(),o=null,e.style.display="none")}))))}document.addEventListener("DOMContentLoaded",(async()=>{let a=null;if("serviceWorker"in navigator)try{a=await navigator.serviceWorker.register("/firebase-messaging-sw.js",{type:"module"})}catch(e){console.error("ServiceWorker registration failed:",e)}if(window.matchMedia("(display-mode: standalone)").matches){const o=document.getElementById("install-button");o&&(o.style.display="none");const i=document.getElementById("notification-controls");i&&(i.style.display="block"),a&&(!function(t){if(window.matchMedia("(display-mode: standalone)").matches&&!localStorage.getItem("notificationSetupComplete")){const n=document.getElementById("notification-prompt-modal"),a=document.getElementById("enable-notifications-btn"),o=document.getElementById("subscribeAnnouncementsModal"),i=document.getElementById("subscribeJamaatModal"),l=document.getElementById("notification-modal-spinner");if(!(n&&a&&o&&i&&l))return;const c=new bootstrap.Modal(n);c.show(),a.addEventListener("click",(async()=>{l.classList.remove("d-none"),a.disabled=!0;try{let n=!1;o.checked&&await e("announcements",t)&&(localStorage.setItem("announcementNotificationsEnabled","true"),n=!0),i.checked&&await e("jamaat",t)&&(localStorage.setItem("jamaatNotificationsEnabled","true"),n=!0),n?(localStorage.setItem("notificationSetupComplete","true"),alert("Notification settings saved!")):(o.checked||i.checked)&&alert("Could not enable notifications. Please grant permission when prompted."),c.hide()}finally{l.classList.add("d-none"),a.disabled=!1}}))}}(a),function(n){if(window.location.pathname.includes("prayerTimetable.html")){const a=document.getElementById("jamaat-notifications-toggle");a&&(a.checked="true"===localStorage.getItem("jamaatNotificationsEnabled"),a.addEventListener("change",(async a=>{if(a.target.checked){const t=await e("jamaat",n);t||(a.target.checked=!1),localStorage.setItem("jamaatNotificationsEnabled",String(t))}else await t("jamaat",n),localStorage.setItem("jamaatNotificationsEnabled","false")})))}const a=document.getElementById("announcement-toggle-container"),o=document.getElementById("announcement-notifications-toggle-main");a&&o&&window.matchmedia("(display-mode: standalone)").matches&&(a.style.display="block",o.checked="true"===localStorage.getItem("announcementNotificationsEnabled"),o.addEventListener("change",(async a=>{if(a.target.checked){const t=await e("announcements",n);t||(a.target.checked=!1),localStorage.setItem("announcementNotificationsEnabled",String(t))}else await t("announcements",n),localStorage.setItem("announcementNotificationsEnabled","false")})))}(a),"true"===localStorage.getItem("jamaatNotificationsEnabled")&&n())}else{i();const e=document.getElementById("notification-controls");e&&(e.style.display="none")}}));