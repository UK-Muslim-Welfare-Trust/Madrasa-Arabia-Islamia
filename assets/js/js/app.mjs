import{subscribeToTopic as e,unsubscribeFromTopic as t}from"./notifications.mjs";import{app as n,db as o}from"./firebase-init.mjs";import{doc as a,setDoc as i,serverTimestamp as s}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";import{getToken as c}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-messaging.js";import{initializeMessaging as l}from"./firebase-init.mjs";let d=null,r=null;function m(){const e=document.getElementById("install-button");e&&(e.style.display="none",/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream?(e.style.display="block",e.addEventListener("click",(()=>{alert('To install, tap the Share button, then scroll down and tap "Add to Home Screen".')}))):(window.addEventListener("beforeinstallprompt",(t=>{t.preventDefault(),d=t,e.style.display="block"})),e.addEventListener("click",(async()=>{d&&(d.prompt(),d=null,e.style.display="none")}))))}async function f(n,o){const a=n.target,i=a.id.includes("jamaat")?"jamaat-spinner":"announcement-spinner",s=document.getElementById(i),c=o.includes("jamaat")?"jamaatNotificationsEnabled":"announcementNotificationsEnabled";a.disabled=!0,s&&s.classList.remove("d-none");try{if(a.checked){const t=await e(o,r);t||(a.checked=!1,"denied"===Notification.permission&&alert("Notifications are blocked. To receive alerts, you must enable permissions for this site in your browser settings.")),localStorage.setItem(c,String(t))}else await t(o,r),localStorage.setItem(c,"false")}finally{a.disabled=!1,s&&s.classList.add("d-none")}}const u=()=>{if("undefined"==typeof jQuery)return;const e=jQuery;e("#spinner").removeClass("show"),e(window).scroll((function(){e(this).scrollTop()>300?e(".sticky-top").addClass("shadow-sm").css("top","0px"):e(".sticky-top").removeClass("shadow-sm").css("top","-150px"),e(this).scrollTop()>100?e(".back-to-top").fadeIn("slow"):e(".back-to-top").fadeOut("slow")}))};document.addEventListener("DOMContentLoaded",(async()=>{if(async function(){if("true"!==localStorage.getItem("announcementNotificationsEnabled")&&"true"!==localStorage.getItem("jamaatNotificationsEnabled"))return;const{messaging:e}=await l();if(e)try{const t=await c(e,{vapidKey:"BCiOgp50gotHnfdiLjtx86mJZ-hGV94JWVuLjsiPsBd-CFAMpg8REdBZs6zb0Ofr5Lpo7Ezu50yAfEhgmcqIcMY"});if(t){const e=a(o,"fcmTokens",t);await i(e,{lastUsed:s()},{merge:!0}),console.log("Token heartbeat updated.")}}catch(e){console.log("Could not update token heartbeat.")}}(),"serviceWorker"in navigator)try{r=await navigator.serviceWorker.register("/firebase-messaging-sw.js"),console.log("ServiceWorker registration successful.")}catch(e){console.error("ServiceWorker registration failed:",e)}if(window.matchMedia("(display-mode: standalone)").matches){const t=document.getElementById("install-button");t&&(t.style.display="none");const n=document.getElementById("notification-controls");n&&(n.style.display="block"),function(){if(window.matchMedia("(display-mode: standalone)").matches&&!localStorage.getItem("notificationSetupComplete")){const t=document.getElementById("notification-prompt-modal"),n=document.getElementById("enable-notifications-btn"),o=document.getElementById("subscribeAnnouncementsModal"),a=document.getElementById("subscribeJamaatModal"),i=document.getElementById("notification-modal-spinner");if(!(t&&n&&o&&a&&i))return;const s=new bootstrap.Modal(t);s.show(),n.addEventListener("click",(async()=>{i.classList.remove("d-none"),n.disabled=!0,localStorage.setItem("notificationSetupComplete","true");try{let t=!1;const c=o.checked,l=a.checked;c&&await e("announcements_v2",r)?(localStorage.setItem("announcementNotificationsEnabled","true"),t=!0):localStorage.setItem("announcementNotificationsEnabled","false"),l&&await e("jamaat_v2",r)?(localStorage.setItem("jamaatNotificationsEnabled","true"),t=!0):localStorage.setItem("jamaatNotificationsEnabled","false"),t?alert("Notification settings saved!"):(c||l)&&("denied"===Notification.permission?alert("Notifications are blocked. To receive alerts, you must enable permissions for this site in your browser settings."):alert("Could not enable notifications. Please try again.")),s.hide()}finally{i.classList.add("d-none"),n.disabled=!1,location.reload()}}))}}(),function(){const e=document.getElementById("jamaat-notifications-toggle");e&&(e.checked="true"===localStorage.getItem("jamaatNotificationsEnabled"),e.addEventListener("change",(e=>f(e,"jamaat_v2"))));const t=document.getElementById("announcement-notifications-toggle-main"),n=document.getElementById("announcement-toggle-container");n&&t&&window.matchMedia("(display-mode: standalone)").matches&&(n.style.display="block",t.checked="true"===localStorage.getItem("announcementNotificationsEnabled"),t.addEventListener("change",(e=>f(e,"announcements_v2"))))}()}else{const e=document.getElementById("notification-controls");e&&(e.style.display="none"),m()}u()}));