import{db as t}from"./firebase-init.mjs";import{doc as e,onSnapshot as n,getDoc as o,collection as a,query as r,orderBy as s,limit as i}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";const d="artifacts/masjid-connect-app/public/data",c=t=>{if(!t||!t.includes(":"))return"--:--";const[e,n]=t.split(":");let o=parseInt(e,10);const a=o>=12?"PM":"AM";return o=o%12||12,`${o}:${n} ${a}`},l=()=>{const t=document.getElementById("donate-card"),e=document.getElementById("announcements-card");t&&e&&requestAnimationFrame((()=>{e.style.height=`${t.offsetHeight}px`}))},m=()=>{const e=document.querySelector("#announcements-card .list-group");if(!e)return;const o=a(t,`${d}/announcements`),c=r(o,s("timestamp","desc"),i(10));n(c,(t=>{e.innerHTML="",t.empty?e.innerHTML='<p class="p-4 text-muted">No announcements at this time.</p>':t.forEach((t=>{const n=t.data(),o=n.timestamp?n.timestamp.toDate():new Date,a=`\n                    <a href="#" class="list-group-item list-group-item-action border-0 py-3 px-2 px-lg-3">\n                        <div class="d-flex w-100 justify-content-between">\n                            <h5 class="mb-1 fs-6 fw-semibold">${n.title||"No Title"}</h5>\n                            <small class="text-body-secondary flex-shrink-0 ms-2">${(t=>{const e=Math.floor((new Date-t)/1e3);let n=e/31536e3;return n>1?`${Math.floor(n)} year${Math.floor(n)>1?"s":""} ago`:(n=e/2592e3,n>1?`${Math.floor(n)} month${Math.floor(n)>1?"s":""} ago`:(n=e/86400,n>1?`${Math.floor(n)} day${Math.floor(n)>1?"s":""} ago`:(n=e/3600,n>1?`${Math.floor(n)} hour${Math.floor(n)>1?"s":""} ago`:(n=e/60,n>1?`${Math.floor(n)} minute${Math.floor(n)>1?"s":""} ago`:`${Math.floor(e)} seconds ago`))))})(o)}</small>\n                        </div>\n                        <p class="mb-1 small">${n.message||""}</p>\n                    </a>`;e.insertAdjacentHTML("beforeend",a)})),l()}),(t=>{console.error("Error fetching announcements:",t),e.innerHTML='<p class="p-4 text-danger">Could not load announcements.</p>',l()}))};document.addEventListener("DOMContentLoaded",(()=>{console.log("Index page DOM loaded. Firing scripts."),(async()=>{const t=document.getElementById("dateTodayC"),e=document.getElementById("dateTodayI");if(t){const e=new Date;t.textContent=e.toLocaleDateString("en-GB",{year:"numeric",month:"short",day:"numeric"})}if(e)try{console.log("Fetching Hijri date...");const t=new Date,n=String(t.getDate()).padStart(2,"0"),o=String(t.getMonth()+1).padStart(2,"0"),a=t.getFullYear(),r=await fetch(`https://api.aladhan.com/v1/gToH?date=${n}-${o}-${a}`);if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const s=await r.json();if(200!==s.code||!s.data.hijri)throw new Error("Invalid response from Hijri API.");{const t=s.data.hijri;e.textContent=`${t.day} ${t.month.en} ${t.year}`,console.log("Hijri date fetched successfully.")}}catch(t){console.error("Could not fetch Hijri date:",t),e.textContent="Could not load Hijri date"}})(),(()=>{const o=e(t,`${d}/prayerTimes/today`);n(o,(t=>{if(!t.exists())return void console.warn("Prayer times document not found in Firestore.");const e=t.data();console.log("Received Jama'ah time update:",e),document.getElementById("pt-fajr").textContent=c(e.Fajr),document.getElementById("pt-zuhr").textContent=c(e.Zuhr),document.getElementById("pt-asr").textContent=c(e.Asr),document.getElementById("pt-isha").textContent=c(e.Isha),document.getElementById("pt-jummah").textContent=c(e.Jumma)}),(t=>{console.error("Error listening to prayer times:",t)}))})(),(async()=>{const n=document.getElementById("pt-maghrib");if(n)try{const a=new Date,r=`${String(a.getDate()).padStart(2,"0")}-${String(a.getMonth()+1).padStart(2,"0")}`,s=e(t,`${d}/prayerCalendar/${r}`),i=await o(s);i.exists()?n.textContent=c(i.data().Maghrib):(n.textContent="N/A",console.warn("Maghrib time not found for today."))}catch(t){console.error("Error fetching Maghrib time:",t),n.textContent="Error"}})(),m(),l(),window.addEventListener("resize",l),window.addEventListener("load",l)}));