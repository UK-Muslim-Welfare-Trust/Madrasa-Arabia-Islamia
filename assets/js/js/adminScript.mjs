import{db as e}from"./firebase-init.mjs";import{doc as t,onSnapshot as n,updateDoc as o,collection as a,addDoc as r,serverTimestamp as c}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";const d="artifacts/masjid-connect-app/public/data";let m,s,l;const i=e=>{if(!e||!e.includes(":"))return e||"--:--";const[t,n]=e.split(":");let o=parseInt(t,10);const a=o>=12?"PM":"AM";return o=o%12||12,`${o}:${n} ${a}`},u=e=>{l=e.currentTarget.dataset.prayer;const t=e.currentTarget.querySelector("span").textContent;if(document.getElementById("prayerNameToEdit").textContent=l.charAt(0).toUpperCase()+l.slice(1),t?.includes(":")){const[e,n]=t.split(":");document.getElementById("hourSelect").value=e.padStart(2,"0"),document.getElementById("minuteSelect").value=n.padStart(2,"0")}m&&m.show()},g=async()=>{const n=`${document.getElementById("hourSelect").value}:${document.getElementById("minuteSelect").value}`,s=document.getElementById("saveTimeButton");if(l){s.disabled=!0,s.textContent="Saving...";try{await o(t(e,`${d}/prayerTimes/today`),{[l]:n}),await r(a(e,`${d}/announcements`),{title:"Jama'ah Time Change",message:`The Jama'ah time for ${l} has been updated to ${i(n)}.`,timestamp:c()}),m&&m.hide()}catch(e){console.error("Failed to save time:",e),alert("Error: Could not save the time.")}finally{s.disabled=!1,s.textContent="Save changes"}}},p=async()=>{const t=document.getElementById("announcementTitle"),n=document.getElementById("announcementMessage"),o=document.getElementById("postAnnouncementBtn"),m=t.value.trim(),l=n.value.trim();if(m&&l){o.disabled=!0,o.textContent="Posting...",console.log("Attempting to post a new announcement...");try{const i=a(e,`${d}/announcements`);await r(i,{title:m,message:l,timestamp:c()}),console.log("Announcement posted successfully."),s&&s.hide(),t.value="",n.value=""}catch(e){console.error("Failed to post announcement:",e),alert("Error: Could not post the announcement. Check the console for details.")}finally{o.disabled=!1,o.textContent="Post Announcement"}}else alert("Please fill out both the title and the message.")};document.addEventListener("DOMContentLoaded",(()=>{const o=document.getElementById("editTimeModal");o&&(m=new bootstrap.Modal(o));const a=document.getElementById("announcementModal");a&&(s=new bootstrap.Modal(a)),document.getElementById("saveTimeButton")?.addEventListener("click",g),document.getElementById("postAnnouncementBtn")?.addEventListener("click",p),document.querySelectorAll(".editable-time").forEach((e=>e.addEventListener("click",u))),(()=>{const e=document.getElementById("hourSelect"),t=document.getElementById("minuteSelect");if(e&&t){for(let t=0;t<24;t++){const n=String(t).padStart(2,"0");e.add(new Option(n,n))}["00","15","30","45"].forEach((e=>{t.add(new Option(e,e))}))}})(),(async()=>{})(),(()=>{const o=t(e,`${d}/prayerTimes/today`);n(o,(e=>{const t=e.exists()?e.data():{};console.log("Admin panel received prayer time update:",t),document.getElementById("p-fajr").textContent=t.Fajr||"00:00",document.getElementById("p-zuhr").textContent=t.Zuhr||"00:00",document.getElementById("p-asr").textContent=t.Asr||"00:00",document.getElementById("p-isha").textContent=t.Isha||"00:00",document.getElementById("p-jummah").textContent=t.Jumma||"00:00",document.getElementById("p-jummah-2").textContent=t.Jumma2||"00:00"}),(e=>console.error("Error listening to prayer times on admin page:",e)))})(),(async()=>{const n=document.getElementById("p-maghrib");if(n)try{const o=new Date,a=`${String(o.getDate()).padStart(2,"0")}-${String(o.getMonth()+1).padStart(2,"0")}`,r=t(e,`${d}/prayerCalendar/${a}`),c=await getDoc(r);c.exists()?n.textContent=i(c.data().Maghrib):(n.textContent="N/A",console.warn("Maghrib time not found for today."))}catch(e){console.error("Error fetching Maghrib time:",e),n.textContent="Error"}})()}));