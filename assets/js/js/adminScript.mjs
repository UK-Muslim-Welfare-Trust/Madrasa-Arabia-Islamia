import{db as t}from"./firebase-init.mjs";import{doc as e,onSnapshot as n,updateDoc as a,collection as o,addDoc as r,serverTimestamp as i,getDoc as d}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";const c="masjid-connect-app";let m=null,l=null,s=null;function u(t){m=t.currentTarget.dataset.prayer;const e=t.currentTarget.querySelector("span").textContent;if(document.getElementById("prayerNameToEdit").textContent=m.charAt(0).toUpperCase()+m.slice(1),e?.includes(":")){const[t,n]=e.split(":");document.getElementById("hourSelect").value=t.padStart(2,"0"),document.getElementById("minuteSelect").value=n.padStart(2,"0")}l?.show()}async function g(){const n=`${document.getElementById("hourSelect").value}:${document.getElementById("minuteSelect").value}`,d=document.getElementById("saveTimeButton");if(m){d.disabled=!0,d.textContent="Saving...";try{const s=e(t,`/artifacts/${c}/public/data/prayerTimes/today`);await a(s,{[m]:n}),await r(o(t,`/artifacts/${c}/public/data/announcements`),{title:"Jama'ah Time Change",message:`The Jama'ah time for ${m} has been updated to ${y(n)}.`,timestamp:i()}),l?.hide()}catch(t){console.error("Failed to save time:",t),alert("Error: Could not save the time.")}finally{d.disabled=!1,d.textContent="Save changes"}}}async function p(){const e=document.getElementById("announcementTitle"),n=document.getElementById("announcementMessage"),a=document.getElementById("postAnnouncementBtn"),d=e.value.trim(),m=n.value.trim();if(!d||!m)return alert("Please fill out both the title and the message.");a.disabled=!0,a.textContent="Posting...";try{await r(o(t,`/artifacts/${c}/public/data/announcements`),{title:d,message:m,timestamp:i()}),s?.hide(),e.value="",n.value=""}catch(t){console.error("Failed to post announcement:",t),alert("Error: Could not post the announcement.")}finally{a.disabled=!1,a.textContent="Post Announcement"}}function y(t){if(!t||!t.includes(":"))return t||"--:--";const[e,n]=t.split(":");let a=parseInt(e,10);const o=a>=12?"PM":"AM";return a=a%12||12,`${a}:${n} ${o}`}document.addEventListener("DOMContentLoaded",(()=>{!function(){const t=document.getElementById("editTimeModal");t&&(l=new bootstrap.Modal(t));const e=document.getElementById("announcementModal");e&&(s=new bootstrap.Modal(e));document.getElementById("saveTimeButton")?.addEventListener("click",g),document.getElementById("postAnnouncementBtn")?.addEventListener("click",p),document.querySelectorAll(".editable-time").forEach((t=>t.addEventListener("click",u))),function(){const t=document.getElementById("hourSelect"),e=document.getElementById("minuteSelect");if(!t||!e)return;for(let e=0;e<24;e++)t.add(new Option(String(e).padStart(2,"0"),String(e).padStart(2,"0")));["00","05","10","15","20","25","30","35","40","45","50","55"].forEach((t=>e.add(new Option(t,t))))}()}(),async function(){const t=document.getElementById("dateTodayC2"),e=document.getElementById("dateTodayI2"),n=new Date;t&&(t.textContent=n.toLocaleDateString("en-GB",{year:"numeric",month:"short",day:"numeric"}));if(e)try{const t=String(n.getDate()).padStart(2,"0"),a=String(n.getMonth()+1).padStart(2,"0"),o=n.getFullYear(),r=await fetch(`https://api.aladhan.com/v1/gToH?date=${t}-${a}-${o}`);if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const i=await r.json();e.textContent=200===i.code&&i.data.hijri?`${i.data.hijri.day} ${i.data.hijri.month.en} ${i.data.hijri.year}`:"Hijri date unavailable"}catch(t){console.error("Could not fetch Hijri date:",t),e.textContent="Could not load Hijri date"}}(),function(){const a=e(t,`/artifacts/${c}/public/data/prayerTimes/today`);n(a,(t=>{const e=t.exists()?t.data():{};document.getElementById("p-fajr").textContent=e.Fajr||"00:00",document.getElementById("p-zuhr").textContent=e.Zuhr||"00:00",document.getElementById("p-asr").textContent=e.Asr||"00:00",document.getElementById("p-isha").textContent=e.Isha||"00:00",document.getElementById("p-jummah").textContent=e.Jumma||"00:00",document.getElementById("p-jummah-2").textContent=e.Jumma2||"00:00"}),(t=>console.error("Error listening to prayer times:",t)))}(),async function(){const n=document.getElementById("p-maghrib");if(!n)return;try{const a=new Date,o=`${String(a.getDate()).padStart(2,"0")}-${String(a.getMonth()+1).padStart(2,"0")}`,r=e(t,`/artifacts/${c}/public/data/prayerCalendar/${o}`),i=await d(r);n.textContent=i.exists()?i.data().Maghrib:"N/A"}catch(t){console.error("Error fetching Maghrib time: ",t),n.textContent="Error"}}()}));