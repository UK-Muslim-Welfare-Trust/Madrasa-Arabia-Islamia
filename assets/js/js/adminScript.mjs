import{doc as t,onSnapshot as e,setLogLevel as n,updateDoc as a,collection as o,addDoc as r,serverTimestamp as i,getDoc as c}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";const s="masjid-connect-app";let d,l,m,u,g,y,p,f,h,b,w=null,E=null;async function C(){if(!w||!window.firebaseDb)return void console.error("Cannot save: prayer name or DB instance is missing.");const e=`${u.value}:${g.value}`,n=w;y.disabled=!0,y.textContent="Saving...";try{const c=window.firebaseDb,d=`/artifacts/${s}/public/data/prayerTimes/today`,l=t(c,d);console.log(`Updating ${n} to ${e} at ${d}`),await a(l,{[n]:e}),await async function(t,e,n){const a=o(t,`/artifacts/${s}/public/data/announcements`),c={title:"Jama'ah Time Change",message:`The Jama'ah time for ${e.charAt(0).toUpperCase()+e.slice(1)} has been updated to ${n}.`,timestamp:i()};try{await r(a,c),console.log("Successfully created prayer time update announcement.")}catch(t){console.error("Failed to create announcement for prayer time change:",t)}}(c,n,e),console.log("Successfully updated time."),E.hide()}catch(t){console.error("Failed to save time to Firestore:",t),alert("Error: Could not save the time. Please try again.")}finally{y.disabled=!1,y.textContent="Save changes"}}async function v(){const t=f.value.trim(),e=h.value.trim();if(t&&e){b.disabled=!0,b.textContent="Posting...";try{const n=window.firebaseDb,a=o(n,`/artifacts/${s}/public/data/announcements`),c={title:t,message:e,timestamp:i()};await r(a,c),console.log("Successfully posted new announcement."),p.hide(),f.value="",h.value=""}catch(t){console.error("Failed to post announcement:",t),alert("Error: Could not post the announcement. Please try again.")}finally{b.disabled=!1,b.textContent="Post Announcement"}}else alert("Please fill out both the title and the message.")}document.addEventListener("DOMContentLoaded",(async function(){d=document.getElementById("dateTodayC2"),l=document.getElementById("dateTodayI2"),m=document.getElementById("prayerNameToEdit"),u=document.getElementById("hourSelect"),g=document.getElementById("minuteSelect"),y=document.getElementById("saveTimeButton");const n=document.getElementById("announcementModal");p=new bootstrap.Modal(n),f=document.getElementById("announcementTitle"),h=document.getElementById("announcementMessage"),b=document.getElementById("postAnnouncementBtn"),function(){const t=new Date;d.textContent=t.toLocaleDateString("en-GB",{year:"numeric",month:"short",day:"numeric"})}(),await async function(){try{const t=new Date,e=String(t.getDate()).padStart(2,"0"),n=String(t.getMonth()+1).padStart(2,"0"),a=t.getFullYear(),o=await fetch(`https://api.aladhan.com/v1/gToH?date=${e}-${n}-${a}`);if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const r=await o.json();if(200===r.code&&r.data.hijri){const t=r.data.hijri;l.textContent=`${t.day} ${t.month.en} ${t.year}`}else l.textContent="Hijri date unavailable"}catch(t){console.error("Could not fetch Hijri date:",t),l.textContent="Could not load Hijri date"}}(),function(){for(let t=0;t<24;t++){const e=String(t).padStart(2,"0"),n=new Option(e,e);u.add(n)}["00","15","30","45"].forEach((t=>{const e=new Option(t,t);g.add(e)}))}();const a=document.getElementById("editTimeModal");E=new bootstrap.Modal(a),document.querySelectorAll(".editable-time").forEach((t=>{t.addEventListener("click",(t=>{!function(t,e){w=t;const n=t.charAt(0).toUpperCase()+t.slice(1);if(m.textContent=n,e&&e.includes(":")){const[t,n]=e.split(":");u.value=t;const a=parseInt(n,10);g.value=a<8?"00":a<23?"15":a<38?"30":"45"}E.show()}(t.currentTarget.dataset.prayer,t.currentTarget.querySelector("span").textContent)}))})),y.addEventListener("click",C),b.addEventListener("click",v);const o=setInterval((()=>{void 0!==window.firebaseDb?(clearInterval(o),console.log("Firebase DB instance found. Subscribing to prayer times."),function(n){const a=`/artifacts/${s}/public/data/prayerTimes/today`;console.log(`Listening for prayer times at: ${a}`);const o=t(n,a);e(o,(t=>{if(t.exists()){console.log("Received prayer times data:",t.data());const e=t.data();document.getElementById("p-fajr").textContent=e.Fajr||"00:00",document.getElementById("p-zuhr").textContent=e.Zuhr||"00:00",document.getElementById("p-asr").textContent=e.Asr||"00:00",document.getElementById("p-isha").textContent=e.Isha||"00:00",document.getElementById("p-jummah").textContent=e.Jumma||"00:00",document.getElementById("p-jummah-2").textContent=e.Jumma2||"00:00"}else console.warn("Prayer times document does not exist for today at path:",a),["fajr","zuhr","asr","maghrib","isha","jummah"].forEach((t=>{document.getElementById(`pt-${t}`).textContent="N/A"}))}),(t=>{console.error("Error listening to prayer times:",t)}))}(window.firebaseDb),async function(e){const n=new Date,a=`${String(n.getDate()).padStart(2,"0")}-${String(n.getMonth()+1).padStart(2,"0")}`,o=t(e,`/artifacts/${s}/public/data/prayerCalendar/${a}`);try{const t=await c(o),e=document.getElementById("p-maghrib");if(t.exists()){const n=t.data();e&&(e.textContent=n.Maghrib||"N/A")}else e&&(e.textContent="N/A"),console.warn(`Prayer calendar document does not exist for today: ${a}`)}catch(t){console.error("Error fetching Maghrib time from calendar:",t);const e=document.getElementById("p-maghrib");e&&(e.textContent="Error")}}(window.firebaseDb)):console.log("Waiting for Firebase DB instance to become available...")}),100)}));