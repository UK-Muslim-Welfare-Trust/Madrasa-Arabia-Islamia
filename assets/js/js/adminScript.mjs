import{db as e}from"./firebase-init.mjs";import{doc as t,onSnapshot as n,updateDoc as o,getDoc as a,collection as r,addDoc as d,serverTimestamp as c}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";const m="artifacts/masjid-connect-app/public/data";let s,l,i;const u=e=>{if(!e||!e.includes(":"))return e||"--:--";const[t,n]=e.split(":");let o=parseInt(t,10);const a=o>=12?"PM":"AM";return o=o%12||12,`${o}:${n} ${a}`},g=e=>{i=e.currentTarget.dataset.prayer;const t=e.currentTarget.querySelector("span").textContent;if(document.getElementById("prayerNameToEdit").textContent=i.charAt(0).toUpperCase()+i.slice(1),t?.includes(":")){const[e,n]=t.split(":");document.getElementById("hourSelect").value=e.padStart(2,"0"),document.getElementById("minuteSelect").value=n.padStart(2,"0")}s&&s.show()},p=async()=>{const n=`${document.getElementById("hourSelect").value}:${document.getElementById("minuteSelect").value}`,a=document.getElementById("saveTimeButton");if(i){a.disabled=!0,a.textContent="Saving...";try{await o(t(e,`${m}/prayerTimes/today`),{[i]:n}),await d(r(e,`${m}/announcements`),{title:"Jama'ah Time Change",message:`The Jama'ah time for ${i} has been updated to ${u(n)}.`,timestamp:c()}),s&&s.hide()}catch(e){console.error("Failed to save time:",e),alert("Error: Could not save the time.")}finally{a.disabled=!1,a.textContent="Save changes"}}},y=async()=>{const t=document.getElementById("announcementTitle"),n=document.getElementById("announcementMessage"),o=document.getElementById("postAnnouncementBtn"),a=t.value.trim(),s=n.value.trim();if(a&&s){o.disabled=!0,o.textContent="Posting...",console.log("Attempting to post a new announcement...");try{const i=r(e,`${m}/announcements`);await d(i,{title:a,message:s,timestamp:c()}),console.log("Announcement posted successfully."),l&&l.hide(),t.value="",n.value=""}catch(e){console.error("Failed to post announcement:",e),alert("Error: Could not post the announcement. Check the console for details.")}finally{o.disabled=!1,o.textContent="Post Announcement"}}else alert("Please fill out both the title and the message.")};document.addEventListener("DOMContentLoaded",(()=>{const o=document.getElementById("editTimeModal");o&&(s=new bootstrap.Modal(o));const r=document.getElementById("announcementModal");r&&(l=new bootstrap.Modal(r)),document.getElementById("saveTimeButton")?.addEventListener("click",p),document.getElementById("postAnnouncementBtn")?.addEventListener("click",y),document.querySelectorAll(".editable-time").forEach((e=>e.addEventListener("click",g))),(()=>{const e=document.getElementById("hourSelect"),t=document.getElementById("minuteSelect");if(e&&t){for(let t=0;t<24;t++){const n=String(t).padStart(2,"0");e.add(new Option(n,n))}["00","15","30","45"].forEach((e=>{t.add(new Option(e,e))}))}})(),(async()=>{})(),(()=>{const o=t(e,`${m}/prayerTimes/today`);n(o,(e=>{const t=e.exists()?e.data():{};console.log("Admin panel received prayer time update:",t),document.getElementById("p-fajr").textContent=t.Fajr||"00:00",document.getElementById("p-zuhr").textContent=t.Zuhr||"00:00",document.getElementById("p-asr").textContent=t.Asr||"00:00",document.getElementById("p-isha").textContent=t.Isha||"00:00",document.getElementById("p-jummah").textContent=t.Jumma||"00:00",document.getElementById("p-jummah-2").textContent=t.Jumma2||"00:00"}),(e=>console.error("Error listening to prayer times on admin page:",e)))})(),(async()=>{const n=document.getElementById("p-maghrib");if(n)try{const o=new Date,r=`${String(o.getDate()).padStart(2,"0")}-${String(o.getMonth()+1).padStart(2,"0")}`,d=t(e,`${m}/prayerCalendar/${r}`),c=await a(d);c.exists()?n.textContent=u(c.data().Maghrib):(n.textContent="N/A",console.warn("Maghrib time not found for today."))}catch(e){console.error("Error fetching Maghrib time:",e),n.textContent="Error"}})()}));