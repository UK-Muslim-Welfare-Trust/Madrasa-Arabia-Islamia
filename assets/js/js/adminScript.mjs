import{db as t}from"./firebase-init.mjs";import{doc as e,onSnapshot as n,updateDoc as a,collection as o,addDoc as r,serverTimestamp as i,getDoc as d}from"https://www.gstatic.com/firebase/firestore";const c="masjid-connect-app";let s,l,m,u,g,p,y,h,f,E,C,B=null;async function x(){if(!B||!t)return void console.error("Cannot save: prayer name or DB instance is missing.");const n=`${u.value}:${g.value}`,d=B;p.disabled=!0,p.textContent="Saving...";try{const s=e(t,`/artifacts/${c}/public/data/prayerTimes/today`);await a(s,{[d]:n});const l=o(t,`/artifacts/${c}/public/data/announcements`);await r(l,{title:"Jama'ah Time Change",message:`The Jama'ah time for ${d.charAt(0).toUpperCase()+d.slice(1)} has been updated to ${n}.`,timestamp:i()}),console.log("Successfully updated time and created announcement."),C.hide()}catch(t){console.error("Failed to save time to Firestore:",t),alert("Error: Could not save the time. Please try again.")}finally{p.disabled=!1,p.textContent="Save changes"}}async function I(){const e=h.value.trim(),n=f.value.trim();if(e&&n){E.disabled=!0,E.textContent="Posting...";try{const a=o(t,`/artifacts/${c}/public/data/announcements`);await r(a,{title:e,message:n,timestamp:i()}),console.log("Successfully posted new announcement."),bootstrap.Modal.getInstance(y).hide(),h.value="",f.value=""}catch(t){console.error("Failed to post announcement:",t),alert("Error: Could not post the announcement. Please try again.")}finally{E.disabled=!1,E.textContent="Post Announcement"}}else alert("Please fill out both the title and the message.")}document.addEventListener("DOMContentLoaded",(async function(){s=document.getElementById("dateTodayC2"),l=document.getElementById("dateTodayI2"),m=document.getElementById("prayerNameToEdit"),u=document.getElementById("hourSelect"),g=document.getElementById("minuteSelect"),p=document.getElementById("saveTimeButton"),y=document.getElementById("announcementModal"),h=document.getElementById("announcementTitle"),f=document.getElementById("announcementMessage"),E=document.getElementById("postAnnouncementBtn");const a=document.getElementById("editTimeModal");a&&(C=new bootstrap.Modal(a));const o=new Date;s.textContent=o.toLocaleDateString("en-GB",{year:"numeric",month:"short",day:"numeric"});try{const t=String(o.getDate()).padStart(2,"0"),e=String(o.getMonth()+1).padStart(2,"0"),n=o.getFullYear(),a=await fetch(`https://api.aladhan.com/v1/gToH?date=${t}-${e}-${n}`);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const r=await a.json();if(200===r.code&&r.data.hijri){const t=r.data.hijri;l.textContent=`${t.day} ${t.month.en} ${t.year}`}else l.textContent="Hijri date unavailable"}catch(t){console.error("Could not fetch Hijri date:",t),l.textContent="Could not load Hijri date"}for(let t=0;t<24;t++)u.add(new Option(String(t).padStart(2,"0"),String(t).padStart(2,"0")));["00","15","30","45"].forEach((t=>g.add(new Option(t,t)))),document.querySelectorAll(".editable-time").forEach((t=>{t.addEventListener("click",(t=>{B=t.currentTarget.dataset.prayer;const e=t.currentTarget.querySelector("span").textContent;if(m.textContent=B.charAt(0).toUpperCase()+B.slice(1),e&&e.includes(":")){const[t,n]=e.split(":");u.value=t,g.value=n}C.show()}))})),p.addEventListener("click",x),E.addEventListener("click",I);const r=e(t,`/artifacts/${c}/public/data/prayerTimes/today`);n(r,(t=>{if(t.exists()){const e=t.data();document.getElementById("p-fajr").textContent=e.Fajr||"00:00",document.getElementById("p-zuhr").textContent=e.Zuhr||"00:00",document.getElementById("p-asr").textContent=e.Asr||"00:00",document.getElementById("p-isha").textContent=e.Isha||"00:00",document.getElementById("p-jummah").textContent=e.Jumma||"00:00",document.getElementById("p-jummah-2").textContent=e.Jumma2||"00:00"}else console.warn("Prayer times document does not exist for today.")}),(t=>console.error("Error listening to prayer times:",t)));const i=`${String(o.getDate()).padStart(2,"0")}-${String(o.getMonth()+1).padStart(2,"0")}`,b=e(t,`/artifacts/${c}/public/data/prayerCalendar/${i}`);try{const t=await d(b),e=document.getElementById("p-maghrib");t.exists()?e.textContent=t.data().Maghrib||"N/A":e.textContent="N/A"}catch(t){console.error("Error fetching Maghrib time: ",t),document.getElementById("p-maghrib").textContent="Error"}}));