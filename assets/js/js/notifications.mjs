import{db as t,initializeMessaging as i}from"./firebase-init.mjs";import{doc as e,onSnapshot as s,setDoc as o}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";import{getToken as n,onMessage as a}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-messaging.js";!async function(){const{messaging:t,messagingSupported:e}=await i();e&&a(t,(t=>{console.log("Message received while app is in foreground: ",t),new Notification(t.notification.title,{body:t.notification.body,icon:"/assets/img/fav192.png"})}))}();export async function requestNotificationPermission(){const{messaging:t,messagingSupported:e}=await i();if(!e)return console.error("Messaging is not supported, cannot request permission."),null;try{return"granted"===await Notification.requestPermission()?await getAndSaveToken():null}catch(t){return console.error("Error requesting notification permission.",t),null}}let r=[];export function scheduleJamaatNotifications(){if(!messagingSupported)return;const i=e(t,"/artifacts/masjid-connect-app/public/data/prayerTimes/today");s(i,(t=>{if(r.forEach(clearTimeout),r=[],t.exists()){const i=t.data(),e=new Date;for(const t in i){const s=i[t];if("string"!=typeof s||!s.includes(":"))continue;const[o,n]=s.split(":"),a=new Date;a.setHours(o,n,0,0);const c=new Date(a.getTime()-9e5);if(c>e){const i=c.getTime()-e.getTime(),s=setTimeout((()=>{"granted"===Notification.permission&&"true"===localStorage.getItem("jamaatNotificationsEnabled")&&new Notification(`${t} Jamaat Reminder`,{body:`Jamaat for ${t} is in 15 minutes.`,icon:"/assets/img/fav192.png",tag:`jamaat-${t}`})}),i);r.push(s)}}}}))}