import{db as t,initializeMessaging as a}from"./firebase-init.mjs";import{doc as e,getDoc as i,setDoc as r,deleteDoc as s}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";import{getToken as n}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-messaging.js";export async function fetchAndScheduleJamaatReminders(){(await self.registration.getNotifications({tag:"jamaat-reminder"})).forEach((t=>t.close()));try{const a=e(t,"/artifacts/masjid-connect-app/public/data/prayerTimes/today"),r=await i(a),s=r.exists()?r.data():{},n=new Date,o=`${String(n.getDate()).padStart(2,"0")}-${String(n.getMonth()+1).padStart(2,"0")}`,c=e(t,`/artifacts/masjid-connect-app/public/data/prayerCalendar/${o}`),m=await i(c);m.exists()&&m.data().Maghrib&&(s.Maghrib=m.data().Maghrib);const g=new Date,f=5===g.getDay(),d=["Fajr","Asr","Maghrib","Isha"];f?d.push("Jumma"):d.push("Zuhr");let u=0;for(const t of d){const a=s[t];if("string"!=typeof a||!a.includes(":"))continue;const[e,i]=a.split(":"),r=new Date;r.setHours(e,i,0,0);const n=r.getTime()-9e5;n>g.getTime()&&(self.registration.showNotification(`${t} Jamaat Reminder`,{body:`Jamaat for ${t} is in 15 minutes.`,icon:"/fav192.png",tag:"jamaat-reminder",timestamp:n}),u++)}console.log(`[SW] Scheduled ${u} new reminders.`)}catch(t){console.error("[SW] Error fetching and scheduling reminders:",t)}}export async function subscribeToTopic(i,s){const{messaging:o,messagingSupported:c}=await a();if(!c)return alert("Push notifications are not supported on this device."),!1;try{const a=await n(o,{vapidKey:"BCiOgp50gotHnfdiLjtx86mJZ-hGV94JWVuLjsiPsBd-CFAMpg8REdBZs6zb0Ofr5Lpo7Ezu50yAfEhgmcqIcMY",serviceWorkerRegistration:serviceWorkerRegistration});if(a){const s="announcements"===i?"announcementTokens":"jamaatTokens";return await r(e(t,s,a),{subscribedAt:new Date}),"jamaat"===i&&await fetchAndScheduleJamaatReminders(),!0}return!1}catch(t){return console.error(`Error subscribing to ${i}:`,t),!1}}export async function unsubscribeFromTopic(i,r){const{messaging:o}=await a(),c=await n(o,{serviceWorkerRegistration:serviceWorkerRegistration});if(!c)return;const m="announcements"===i?"announcementTokens":"jamaatTokens";if(await s(e(t,m,c)),"jamaat"===i){(await r.getNotifications({tag:"jamaat-reminder"})).forEach((t=>t.close()))}}