import{db as e,messaging as t,messagingSupported as i}from"./firebase-init.mjs";import{doc as n,onSnapshot as o,setDoc as r}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";import{getToken as s,onMessage as a}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-messaging.js";if(i)a(t,(e=>{console.log("Message received while app is in foreground: ",e);const t=e.notification.title,i={body:e.notification.body,icon:"/assets/img/fav192.png"};new Notification(t,i)}));else{const e=document.querySelector(".form-check.form-switch");e&&(e.style.display="none")}export async function requestNotificationPermission(){if(!i)return console.error("Messaging is not supported in this browser."),null;try{return"granted"===await Notification.requestPermission()?async function(){if(!i)return null;try{const i=await s(t,{vapidKey:"YOUR_VAPID_KEY"});return i?(function(t){const i=n(e,"fcmTokens",t);r(i,{token:t,createdAt:new Date})}(i),i):null}catch(e){return console.error("An error occurred while retrieving token. ",e),null}}():(console.error("Unable to get permission to notify."),null)}catch(e){return console.error("Error requesting notification permission.",e),null}}export function scheduleJamaatNotifications(){if(!i)return;const t=n(e,"/artifacts/masjid-connect-app/public/data/prayerTimes/today");o(t,(e=>{if(e.exists()){const t=e.data(),i=new Date;for(const e in t)if(Object.hasOwnProperty.call(t,e)){const n=t[e];if("string"!=typeof n||!n.includes(":"))continue;const[o,r]=n.split(":"),s=new Date;s.setHours(o,r,0,0);const a=new Date(s.getTime()-9e5);if(a>i){const t=a.getTime()-i.getTime();setTimeout((()=>{"granted"===Notification.permission&&new Notification(`${e} Jamaat Reminder`,{body:`Jamaat for ${e} is in 15 minutes.`,icon:"/assets/img/fav192.png"})}),t)}}}}))}