import{db as e,messaging as o,messagingSupported as t}from"./firebase-init.mjs";import{doc as i,onSnapshot as n,setDoc as s}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";import{getToken as r,onMessage as a}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-messaging.js";let c=[];t&&a(o,(e=>{console.log("Message received while app is in foreground: ",e);const{title:o,body:t,icon:i}=e.notification;new Notification(o,{body:t,icon:i||"/assets/img/fav192.png"})}));export async function requestNotificationPermission(){if(!t)return console.error("Messaging is not supported in this browser."),null;try{console.log("Requesting notification permission...");if("granted"!==await Notification.requestPermission())return console.warn("Unable to get permission to notify."),null;console.log("Notification permission granted.");try{const t=await r(o,{vapidKey:"BCiOgp50gotHnfdiLjtx86mJZ-hGV94JWVuLjsiPsBd-CFAMpg8REdBZs6zb0Ofr5Lpo7Ezu50yAfEhgmcqIcMY"});return t?await(async o=>{if(!o)return null;try{console.log("Saving FCM token to Firestore:",o);const t=i(e,"fcmTokens",o);return await s(t,{token:o,createdAt:new Date}),console.log("FCM token saved successfully."),o}catch(e){return console.error("Error saving FCM token:",e),null}})(t):null}catch(e){return console.error("An error occurred while retrieving token.",e),null}}catch(e){return console.error("Error requesting notification permission.",e),null}}export function scheduleJamaatNotifications(){if(!t)return;console.log("Setting up listener for prayer time notifications...");const o=i(e,"/artifacts/masjid-connect-app/public/data/prayerTimes/today");n(o,(e=>{if(c.forEach((e=>clearTimeout(e))),c=[],console.log("Cleared all previously scheduled notifications."),e.exists()){const o=e.data(),t=new Date;console.log("Received new prayer times for scheduling:",o);for(const e in o)if(Object.hasOwnProperty.call(o,e)){const i=o[e];if("string"!=typeof i||!i.includes(":"))continue;const[n,s]=i.split(":"),r=new Date;r.setHours(n,s,0,0);const a=new Date(r.getTime()-9e5);if(a>t){const o=a.getTime()-t.getTime();console.log(`Scheduling notification for ${e} at ${a.toLocaleTimeString()} (in ${Math.round(o/6e4)} minutes).`);const i=setTimeout((()=>{"granted"===Notification.permission&&"true"===localStorage.getItem("jamaatNotificationsEnabled")&&(new Notification(`${e} Jamaat Reminder`,{body:`Jamaat for ${e} is in 15 minutes.`,icon:"/assets/img/fav192.png",tag:`jamaat-${e}`}),console.log(`Notification shown for ${e}.`))}),o);c.push(i)}}}else console.warn("Prayer times document does not exist. No notifications scheduled.")}))}