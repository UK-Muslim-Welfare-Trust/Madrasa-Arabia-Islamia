import{db as t,messaging as o,messagingSupported as i}from"./firebase-init.mjs";import{doc as e,onSnapshot as n,setDoc as a}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";import{getToken as s}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-messaging.js";let r=[];export async function requestLocalNotificationPermission(){if(!("Notification"in window))return console.error("This browser does not support local notifications."),!1;try{return"granted"===await Notification.requestPermission()}catch(t){return console.error("Error requesting local notification permission:",t),!1}}export function scheduleJamaatNotifications(){console.log("Setting up listener to schedule Jama'at notifications...");const o=e(t,"/artifacts/masjid-connect-app/public/data/prayerTimes/today");n(o,(t=>{if(cancelJamaatNotifications(),t.exists()){const o=t.data(),i=new Date;for(const t in o){const e=o[t];if("string"!=typeof e||!e.includes(":"))continue;const[n,a]=e.split(":"),s=new Date;s.setHours(n,a,0,0);const c=new Date(s.getTime()-9e5);if(c>i){const o=c.getTime()-i.getTime(),e=setTimeout((()=>{"granted"===Notification.permission&&"true"===localStorage.getItem("jamaatNotificationsEnabled")&&new Notification(`${t} Jamaat Reminder`,{body:`Jamaat for ${t} is in 15 minutes.`,icon:"/fav192.png",tag:`jamaat-${t}`})}),o);r.push(e)}}}}))}export function cancelJamaatNotifications(){console.log("Cancelling all scheduled Jama'at notifications."),r.forEach((t=>clearTimeout(t))),r=[]}export async function requestPushNotificationPermission(){if(!i)return console.error("Firebase Messaging is not supported in this browser."),alert("Push notifications are not supported on this device or browser."),!1;try{const i="BCiOgp50gotHnfdiLjtx86mJZ-hGV94JWVuLjsiPsBd-CFAMpg8REdBZs6zb0Ofr5Lpo7Ezu50yAfEhgmcqIcMY",n=await s(o,{vapidKey:i});if(n){const o=e(t,"fcmTokens",n);return await a(o,{token:n,createdAt:new Date}),console.log("Push notification token saved to Firestore."),!0}return console.warn("Could not get push notification token."),!1}catch(t){return console.error("An error occurred while getting push notification token:",t),!1}}