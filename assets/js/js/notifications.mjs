import{db as t,messaging as e,messagingSupported as i}from"./firebase-init.mjs";import{doc as o,onSnapshot as n,setDoc as r}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";import{getToken as s,onMessage as a}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-messaging.js";i&&a(e,(t=>{console.log("Message received while app is in foreground: ",t);const e=t.notification.title,i={body:t.notification.body,icon:"/assets/img/fav192.png"};new Notification(e,i)}));export async function requestNotificationPermission(){if(!i)return console.error("Messaging is not supported in this browser."),null;try{return"granted"===await Notification.requestPermission()?async function(){if(!i)return null;try{const i=await s(e,{vapidKey:"YOUR_VAPID_KEY_HERE"});if(i){const e=o(t,"fcmTokens",i);return r(e,{token:i,createdAt:new Date}),i}return null}catch(t){return console.error("An error occurred while retrieving token. ",t),null}}():(console.error("Unable to get permission to notify."),null)}catch(t){return console.error("Error requesting notification permission.",t),null}}let c=[];export function scheduleJamaatNotifications(){if(!i)return;const e=o(t,"/artifacts/masjid-connect-app/public/data/prayerTimes/today");n(e,(t=>{if(c.forEach((t=>clearTimeout(t))),c=[],t.exists()){const e=t.data(),i=new Date;for(const t in e)if(Object.hasOwnProperty.call(e,t)){const o=e[t];if("string"!=typeof o||!o.includes(":"))continue;const[n,r]=o.split(":"),s=new Date;s.setHours(n,r,0,0);const a=new Date(s.getTime()-9e5);if(a>i){const e=a.getTime()-i.getTime(),o=setTimeout((()=>{if("granted"===Notification.permission&&"true"===localStorage.getItem("jamaatNotificationsEnabled")){new Notification(`${t} Jamaat Reminder`,{body:`Jamaat for ${t} is in 15 minutes.`,icon:"/assets/img/fav192.png",tag:`jamaat-${t}`})}}),e);c.push(o)}}}}))}