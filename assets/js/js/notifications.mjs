import{getFirestore as e,doc as o,onSnapshot as t,setDoc as i,getDoc as n}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";import{getMessaging as s,getToken as r,onMessage as a,isSupported as c}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-messaging.js";let l;const f=e(),g="BCiOgp50gotHnfdiLjtx86mJZ-hGV94JWVuLjsiPsBd-CFAMpg8REdBZs6zb0Ofr5Lpo7Ezu50yAfEhgmcqIcMY";c().then((e=>{if(e)l=s(),console.log("Firebase Messaging is supported."),a(l,(e=>{console.log("Message received while app is in foreground: ",e);const o=e.notification.title,t={body:e.notification.body,icon:"/assets/img/fav192.png"};new Notification(o,t)}));else{console.log("Firebase Messaging is not supported in this browser. Hiding notification controls.");const e=document.querySelector(".form-check.form-switch");e&&(e.style.display="none")}}));export async function requestNotificationPermission(){if(!l)return console.error("Messaging is not supported or has not been initialized."),null;try{return"granted"===await Notification.requestPermission()?(console.log("Notification permission granted."),async function(){if(!l)return console.error("Messaging is not supported or has not been initialized."),null;try{const e=await r(l,{vapidKey:g});return e?(console.log("FCM Token:",e),function(e){const t=o(f,"fcmTokens",e);i(t,{token:e,createdAt:new Date}).then((()=>console.log("Token saved to Firestore"))).catch((e=>console.error("Error saving token to Firestore: ",e)))}(e),e):(console.log("No registration token available. Request permission to generate one."),null)}catch(e){return console.error("An error occurred while retrieving token. ",e),null}}()):(console.error("Unable to get permission to notify."),null)}catch(e){return console.error("Error requesting notification permission.",e),null}}export function scheduleJamaatNotifications(){if(!l)return void console.error("Messaging is not supported or has not been initialized. Cannot schedule notifications.");const e=o(f,"/artifacts/masjid-connect-app/public/data/prayerTimes/today");t(e,(e=>{if(e.exists()){const o=e.data(),t=new Date;for(const e in o)if(Object.hasOwnProperty.call(o,e)){const i=o[e];if("string"!=typeof i||!i.includes(":"))continue;const[n,s]=i.split(":"),r=new Date;r.setHours(n,s,0,0);const a=new Date(r.getTime()-9e5);if(a>t){const o=a.getTime()-t.getTime();setTimeout((()=>{if("granted"===Notification.permission){new Notification(`${e} Jamaat Reminder`,{body:`Jamaat for ${e} is in 15 minutes.`,icon:"/assets/img/fav192.png"})}}),o)}}}}))}