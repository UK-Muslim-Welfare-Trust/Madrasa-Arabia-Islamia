import{db as t,initializeMessaging as i}from"./firebase-init.mjs";import{doc as e,onSnapshot as o,setDoc as a}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";import{getToken as n,onMessage as s}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-messaging.js";let r=[];!async function(){const{messaging:t,messagingSupported:e}=await i();e&&s(t,(t=>{console.log("Message received while app is in foreground: ",t),new Notification(t.notification.title,{body:t.notification.body,icon:"/assets/img/fav192.png"})}))}();export async function requestNotificationPermission(){const{messaging:t,messagingSupported:e}=await i();if(!e)return console.error("Messaging is not supported, cannot request permission."),null;try{return"granted"===await Notification.requestPermission()?await getAndSaveToken():null}catch(t){return console.error("Error requesting notification permission.",t),null}}export function cancelJamaatNotifications(){console.log("Cancelling all scheduled Jama'at notifications."),r.forEach((t=>clearTimeout(t))),r=[]}export function scheduleJamaatNotifications(){const i=e(t,"/artifacts/masjid-connect-app/public/data/prayerTimes/today");o(i,(t=>{if(cancelJamaatNotifications(),t.exists()){const i=t.data(),e=new Date;for(const t in i){const o=i[t];if("string"!=typeof o||!o.includes(":"))continue;const[a,n]=o.split(":"),s=new Date;s.setHours(a,n,0,0);const r=new Date(s.getTime()-9e5);if(r>e){const i=r.getTime()-e.getTime(),o=setTimeout((()=>{"granted"===Notification.permission&&"true"===localStorage.getItem("jamaatNotificationsEnabled")&&new Notification(`${t} Jamaat Reminder`,{body:`Jamaat for ${t} is in 15 minutes.`,icon:"/assets/img/fav192.png",tag:`jamaat-${t}`})}),i);scheduledTimeouts.push(o)}}}}))}