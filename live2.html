<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Masjid Display — Prayer Times</title>

  <link href="https://fonts.googleapis.com/css2?family=Teko:wght@500;600&family=Work+Sans:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Base Colors */
      --bg-color: #1a1a1a;
      --surface-color: #242424;
      --primary-color: #bf9456;
      --text-color: #e0e0e0;
      --text-secondary-color: #a0a0a0;
      --highlight-color: #d4af37;

      /* Responsive Sizing using vmin for robust scaling.
         By using `vmin` (the smaller of viewport width or height), we ensure
         that the UI scales proportionally even on ultrawide displays, preventing
         vertical overflow when height is the limiting dimension.
      */
      --gap: clamp(0.75rem, 2.5vmin, 1.5rem);
      --radius: clamp(0.75rem, 3vmin, 1.75rem);

      /* Fluid Typography Scale using vmin */
      --font-size-sm: clamp(0.8rem, 2vmin + 0.1rem, 1.25rem);
      --font-size-md: clamp(1rem, 2.5vmin + 0.2rem, 1.75rem);
      --font-size-lg: clamp(1.6rem, 5vmin + 0.5rem, 3.5rem);
      --font-size-xl: clamp(2rem, 7vmin + 0.5rem, 4.5rem);
      --font-size-xxl: clamp(8rem, 30vmin, 20rem);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      width: 100%;
      background: var(--bg-color);
      color: var(--text-color);
      font-family: 'Work Sans', sans-serif;
      overflow: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: var(--gap);
    }

    .wrap {
      display: grid;
      grid-template-columns: 1fr 1.3fr; /* Maintained 2-panel aspect ratio */
      gap: var(--gap);
      height: 100%;
      width: 100%;
    }

    .panel {
      background: var(--surface-color);
      border-radius: var(--radius);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.03), 0 10px 40px rgba(0, 0, 0, 0.55);
      display: flex;
      flex-direction: column;
      padding: calc(var(--gap) * 1.5);
      overflow: hidden;
    }

    /* --- Left Panel Redesign --- */
    .left {
      text-align: center;
      gap: var(--gap);
    }

    .masjid-logo {
      width: clamp(150px, 20vw, 350px); /* Responsive logo size */
      margin: 0 auto;
      cursor: pointer;
      transition: transform .25s ease;
      flex-shrink: 0;
      padding-bottom: var(--gap);
    }
    .masjid-logo:hover { transform: scale(1.02); }
    .masjid-logo img {
      width: 100%;
      height: auto;
      filter: invert(75%) sepia(13%) saturate(1558%) hue-rotate(359deg) brightness(91%) contrast(88%);
    }

    .clock {
      flex-grow: 1; /* Clock takes up all available space */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      min-height: 0;
    }
    .clock-time {
      font-family: 'Teko', sans-serif;
      font-weight: 600;
      font-size: var(--font-size-xxl);
      line-height: 0.9;
      color: var(--text-color);
      text-shadow: 0 0 30px rgba(212, 175, 55, 0.25);
    }
    .clock-sub {
      margin-top: var(--gap);
      display: flex;
      flex-direction: column;
      gap: calc(var(--gap) / 2);
      align-items: center;
    }
    .gregorian {
      font-size: var(--font-size-md);
      color: var(--text-color);
    }
    .hijri {
      font-size: var(--font-size-sm);
      color: var(--primary-color);
      font-weight: 600;
    }

    .message-block {
      width: 100%;
      min-height: 10vmin;
      max-height: 15vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--gap);
      border-radius: var(--radius);
      background: rgba(0,0,0,0.2);
      overflow: hidden;
      text-align: center;
      flex-shrink: 0;
      margin: var(--gap) 0;
    }
    .message-viewport {
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
    }
    .message-content {
      color: var(--text-secondary-color);
      font-size: var(--font-size-sm);
      line-height: 1.4;
      padding: 4px 6px;
      font-style: italic;
    }
    .message-scroller { display: block; }

    footer.left-foot {
      color: var(--text-secondary-color);
      font-size: var(--font-size-sm);
      width: 100%;
      text-align: center;
      padding-top: var(--gap);
      flex-shrink: 0;
    }

    /* --- Right Panel Redesign --- */
    .right {
      display: grid;
      grid-template-rows: 1fr auto;
      gap: var(--gap);
      padding: calc(var(--gap) * 1.5);
    }

    .prayer-list {
      display: flex;
      flex-direction: column;
      justify-content: space-between; /* Changed for better vertical distribution */
    }

    .prayer-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: calc(var(--gap) / 2) calc(var(--gap) * 1.5); /* Reduced vertical padding */
      border-radius: var(--radius);
      border-left: 8px solid transparent;
      transition: all 0.3s ease-in-out;
    }
    .prayer-name {
      font-family: 'Teko', sans-serif;
      font-size: var(--font-size-lg);
      font-weight: 600;
      flex-basis: 40%;
    }
    .prayer-times {
      display: flex;
      justify-content: space-around;
      flex-basis: 60%;
      text-align: center;
    }
    .time-block-label {
      font-size: var(--font-size-sm);
      color: var(--text-secondary-color);
    }
    .time-block-time {
      font-family: 'Teko', sans-serif;
      font-size: var(--font-size-xl);
      line-height: 1.1;
      font-weight: 600;
    }
    .time-block.start-time .time-block-time {
      font-size: var(--font-size-lg);
      color: var(--text-secondary-color);
      font-weight: 500;
    }
    .prayer-item.active {
      background: linear-gradient(90deg, rgba(191,148,86,0.15), transparent);
      border-left-color: var(--highlight-color);
    }
    .prayer-item.active .prayer-name,
    .prayer-item.active .jamaat-time .time-block-time {
      color: var(--primary-color);
    }
    
    .info-row {
      display: flex;
      gap: var(--gap);
      justify-content: center;
      align-items: center;
    }
    .info-mini {
      background: rgba(0,0,0,0.2);
      border-radius: var(--radius);
      padding: var(--gap);
      flex-grow: 1;
      text-align: center;
      color: var(--text-secondary-color);
      border: 1px solid transparent;
      transition: all 0.3s ease;
    }
    .info-mini .time-label { 
        font-weight: 600; 
        font-size: var(--font-size-sm);
    }
    .info-mini .time {
      font-family: 'Teko', sans-serif;
      font-weight: 600;
      color: var(--primary-color);
      font-size: var(--font-size-md);
      margin-top: calc(var(--gap) / 3);
    }
    .info-mini.active {
      color: var(--primary-color);
      border-color: rgba(212, 175, 55, 0.2);
      animation: breathe-info 3.6s ease-in-out infinite;
    }
    @keyframes breathe-info {
      0% { box-shadow: 0 0 15px rgba(212, 175, 55, 0.05); }
      50% { box-shadow: 0 0 30px rgba(212, 175, 55, 0.12); }
      100% { box-shadow: 0 0 15px rgba(212, 175, 55, 0.05); }
    }
    
    /* --- Phone & Rotate Overlays --- */
    .phone-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex;
      align-items: center; justify-content: center; flex-direction: column;
      z-index: 10000; gap: 18px; color: #fff; text-align: center;
      visibility: hidden; opacity: 0; transition: opacity .35s ease, visibility .35s;
    }
    .phone-overlay.visible { visibility: visible; opacity: 1; }
    .phone-overlay .text { font-family: 'Teko', sans-serif; font-size: clamp(1.2rem, 5vh, 5rem); }
    .phone-overlay .smalltime { font-size: clamp(5rem, 20vh, 16rem); color: var(--text-secondary-color); }

    .rotate-overlay {
      position: fixed; inset: 0; background: var(--bg-color);
      display: none; /* Hidden by default */
      flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 20000;
      text-align: center;
      gap: var(--gap);
    }
    .rotate-overlay p {
      font-family: 'Teko', sans-serif;
      font-size: var(--font-size-lg);
      color: var(--text-color);
    }
    .rotate-overlay svg {
      width: clamp(80px, 15vw, 150px);
      color: var(--primary-color);
      opacity: 0.8;
    }

    /* --- LANDSCAPE ONLY MODE --- */
    /* This media query will hide the main content and show the 'Rotate Device' overlay 
       when the screen is in a portrait orientation. */
    @media (orientation: portrait) {
      .wrap { display: none; }
      .rotate-overlay { display: flex; }
    }
  </style>
</head>
<body>
  
  <div class="wrap" role="main">
    <section class="panel left" aria-label="Clock and Info Panel">
      <div class="masjid-logo" id="logo-toggle" title="Click to toggle fullscreen">
        <img src="https://www.wakefieldcentralmosque.co.uk/assets/img/img/logo-mosque.svg" alt="Masjid logo">
      </div>

      <div class="clock" role="status" aria-live="polite">
        <div id="clock-time" class="clock-time">--:--:--</div>
        <div class="clock-sub">
          <div id="gregorian" class="gregorian">---</div>
          <div id="hijri" class="hijri">---</div>
        </div>
      </div>

      <div class="message-block" role="region" aria-live="polite">
        <div id="message-viewport" class="message-viewport">
          <div id="message-content" class="message-content">Loading message...</div>
        </div>
      </div>

      <footer class="left-foot">Please donate generously to support your Masjid.</footer>
    </section>

    <section class="panel right" aria-label="Prayer Timetable">
      <div id="prayer-list" class="prayer-list" role="list">
        <div class="prayer-item" id="item-fajr"><div class="prayer-name">Fajr</div><div class="prayer-times"><div class="time-block start-time"><div class="time-block-label">Start</div><div id="fajr-start" class="time-block-time">--:--</div></div><div class="time-block jamaat-time"><div class="time-block-label">Jama'at</div><div id="fajr-jamaat" class="time-block-time">--:--</div></div></div></div>
        <div class="prayer-item" id="item-zuhr"><div class="prayer-name">Zuhr</div><div class="prayer-times"><div class="time-block start-time"><div class="time-block-label">Start</div><div id="zuhr-start" class="time-block-time">--:--</div></div><div class="time-block jamaat-time"><div class="time-block-label">Jama'at</div><div id="zuhr-jamaat" class="time-block-time">--:--</div></div></div></div>
        <div class="prayer-item" id="item-asr"><div class="prayer-name">Asr</div><div class="prayer-times"><div class="time-block start-time"><div class="time-block-label">Start</div><div id="asr-start" class="time-block-time">--:--</div></div><div class="time-block jamaat-time"><div class="time-block-label">Jama'at</div><div id="asr-jamaat" class="time-block-time">--:--</div></div></div></div>
        <div class="prayer-item" id="item-maghrib"><div class="prayer-name">Maghrib</div><div class="prayer-times"><div class="time-block start-time"><div class="time-block-label">Start</div><div id="maghrib-start" class="time-block-time">--:--</div></div><div class="time-block jamaat-time"><div class="time-block-label">Jama'at</div><div id="maghrib-jamaat" class="time-block-time">--:--</div></div></div></div>
        <div class="prayer-item" id="item-isha"><div class="prayer-name">Isha</div><div class="prayer-times"><div class="time-block start-time"><div class="time-block-label">Start</div><div id="isha-start" class="time-block-time">--:--</div></div><div class="time-block jamaat-time"><div class="time-block-label">Jama'at</div><div id="isha-jamaat" class="time-block-time">--:--</div></div></div></div>
        <div class="prayer-item" id="item-jummah"><div class="prayer-name">Jummah</div><div class="prayer-times"><div class="time-block jamaat-time"><div class="time-block-label">1st Jama'at</div><div id="jummah-1" class="time-block-time">--:--</div></div><div class="time-block jamaat-time"><div class="time-block-label">2nd Jama'at</div><div id="jummah-2" class="time-block-time">--:--</div></div></div></div>
      </div>
      <div class="info-row">
        <div id="sunrise-card" class="info-mini"><div class="time-label">Sunrise</div><div id="sunrise-time" class="time">--:--</div></div>
        <div id="zawwal-card" class="info-mini"><div class="time-label">Zawwal</div><div id="zawwal-time" class="time">--:--</div></div>
        <div id="sunset-card" class="info-mini"><div class="time-label">Sunset</div><div id="sunset-time" class="time">--:--</div></div>
      </div>
    </section>
  </div>

  <div id="phone-overlay" class="phone-overlay" role="dialog" aria-hidden="true">
    <svg style="width:10vmax; max-width:120px; color: var(--primary-color);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="0.8"><path d="M2 2 L22 22"></path><rect x="4" y="3" width="12" height="18" rx="2"></rect><circle cx="18.5" cy="18.5" r="3" fill="currentColor"></circle></svg>
    <div class="text">Please Silence Your Phone</div>
    <div id="overlay-clock" class="smalltime">--:--:--</div>
  </div>

  <div id="rotate-overlay" class="rotate-overlay" aria-hidden="true">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 8.5C3.2 7.2 4.7 6 6.5 6h11C19.3 6 21 7.7 21 9.5v5c0 1.8-1.7 3.5-3.5 3.5h-11c-1.8 0-3.3-1-4-2.3"/><path d="M12 15l3-3-3-3"/></svg>
    <p>Please rotate your device to landscape mode</p>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // All JavaScript remains unchanged as the logic is robust.
  // The only changes required were in the HTML structure and CSS styling.

  const firebaseConfig = {
      apiKey: "AIzaSyDuq7jYQcKDKY3UWNxQwP51fKRwjCERuvo",
      authDomain: "wakefield-central-mosque.firebaseapp.com",
      projectId: "wakefield-central-mosque",
      storageBucket: "wakefield-central-mosque.appspot.com",
      messagingSenderId: "998395111777",
      appId: "1:998395111777:web:5492302e7279822d5cbd20",
      measurementId: "G-NXER4ENDE0"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const ELS = {
      clock: document.getElementById('clock-time'),
      gregorian: document.getElementById('gregorian'),
      hijri: document.getElementById('hijri'),
      messageViewport: document.getElementById('message-viewport'),
      messageContent: document.getElementById('message-content'),
      sunriseTime: document.getElementById('sunrise-time'),
      zawwalTime: document.getElementById('zawwal-time'),
      sunsetTime: document.getElementById('sunset-time'),
      sunriseCard: document.getElementById('sunrise-card'),
      zawwalCard: document.getElementById('zawwal-card'),
      sunsetCard: document.getElementById('sunset-card'),
      logo: document.getElementById('logo-toggle'),
      phoneOverlay: document.getElementById('phone-overlay'),
      overlayClock: document.getElementById('overlay-clock'),
  };

  const HADITHS = [
      "The best of you are those who learn the Qur'an and teach it.",
      "The most beloved deed to Allah is that which is most consistent, even if it is little.",
      "Whoever builds a mosque for Allah, Allah will build for him a house in Paradise.",
      "Charity extinguishes sin as water extinguishes fire.",
      "He who is not grateful to people is not grateful to Allah."
  ];
  
  const MONTH_NAMES = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  const WEEKDAY_NAMES = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

  let prayerCalendar = {}, jamaatToday = {}, messageText = '';
  let wakeLock = null, timeOffset = 0, currentDateStr = '';


  const pad = n => String(n).padStart(2, '0');
  const format12NoSuffix = hm => {
      if (!hm || !hm.includes(':')) return '--:--';
      const [h, m] = hm.split(':');
      let hh = parseInt(h, 10);
      hh = hh % 12 || 12;
      return `${hh}:${pad(m)}`;
  }
  const hmToMinutes = hm => hm && hm.includes(':') ? hm.split(':').map(Number).reduce((h, m) => h * 60 + m) : null;
  const minutesToHM = m => m === null || isNaN(m) ? null : `${pad(Math.floor(m / 60) % 24)}:${pad(m % 60)}`;

  function getCurrentTime() {
      return new Date(Date.now() + timeOffset);
  }

  function saveCache() {
      try {
          localStorage.setItem('masjid_prayerCalendar', JSON.stringify(prayerCalendar));
          localStorage.setItem('masjid_jamaatToday', JSON.stringify(jamaatToday));
          localStorage.setItem('masjid_messageText', messageText);
      } catch (e) { console.warn('Failed to save cache', e); }
  }

  function loadCache() {
      try {
          const calendar = localStorage.getItem('masjid_prayerCalendar');
          const jamaat = localStorage.getItem('masjid_jamaatToday');
          const message = localStorage.getItem('masjid_messageText');
          if (calendar) prayerCalendar = JSON.parse(calendar);
          if (jamaat) jamaatToday = JSON.parse(jamaat);
          if (message) messageText = message;
          return true;
      } catch (e) { return false; }
  }

  function updateClock() {
      const now = getCurrentTime();
      let h = now.getHours();
      const m = pad(now.getMinutes());
      const s = pad(now.getSeconds());
      const h12 = h % 12 || 12;
      const timeString = `${h12}:${m}:${s}`;
      ELS.clock.textContent = timeString;
      ELS.overlayClock.textContent = timeString;
  }

  async function fetchUKTime() {
    const TIME_API_URLS = [
      'https://worldtimeapi.org/api/timezone/Europe/London',
      'https://www.timeapi.io/api/Time/current/zone?timeZone=Europe/London'
    ];

    for (const url of TIME_API_URLS) {
      try {
        console.log(`Attempting to fetch time from: ${url}`);
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Network response was not ok (status: ${res.status})`);
        
        const data = await res.json();
        const timeString = data.datetime || data.dateTime; 
        if (!timeString) throw new Error('Time property not found in API response.');

        const serverTime = new Date(timeString).getTime();
        const localTime = Date.now();
        timeOffset = serverTime - localTime;
        
        console.log(`✅ Time successfully synchronized from ${url}. Offset is ${timeOffset}ms.`);
        return;

      } catch (e) {
        console.warn(`⚠️ Failed to fetch from ${url}. Trying next fallback...`, e.message);
      }
    }
    console.error("❌ All time APIs failed. Falling back to local time.");
    timeOffset = 0;
  }

  async function fetchHijriDate() {
      const now = getCurrentTime();
      try {
          const d = pad(now.getDate()),
              m = pad(now.getMonth() + 1),
              y = now.getFullYear();
          const res = await fetch(`https://api.aladhan.com/v1/gToH?date=${d}-${m}-${y}`);
          if (!res.ok) return;
          const json = await res.json();
          if (json?.data?.hijri) ELS.hijri.textContent = `${json.data.hijri.day} ${json.data.hijri.month.en} ${json.data.hijri.year}H`;
      } catch (e) { console.warn('Hijri fetch failed', e); }
  }

  function setupListeners() {
      const now = getCurrentTime();
      const path = `artifacts/masjid-connect-app/public/data`;
      const day = pad(now.getDate()),
          month = pad(now.getMonth() + 1);

      onSnapshot(doc(db, `${path}/prayerTimes/today`), s => { if (s.exists()) { jamaatToday = s.data(); saveCache(); renderPrayerList(); } });
      onSnapshot(doc(db, `${path}/prayerCalendar/${day}-${month}`), s => { if (s.exists()) { prayerCalendar = s.data(); saveCache(); renderPrayerList(); } });
      onSnapshot(doc(db, `${path}/message/message`), s => {
          messageText = (s.exists() && s.data().text && String(s.data().text).trim()) ? String(s.data().text).trim() : '';
          saveCache();
          renderMessage();
      });
  }

  function renderMessage() {
      const txt = messageText || HADITHS[Math.floor(Math.random() * HADITHS.length)];
      const { messageViewport, messageContent } = ELS;
      if (!messageViewport || !messageContent) return;
      const oldScroller = messageViewport.querySelector('.message-scroller');
      if (oldScroller) { messageViewport.innerHTML = ''; messageViewport.appendChild(messageContent); }
      messageContent.style.animation = '';
      messageContent.textContent = txt;
      requestAnimationFrame(() => {
          const vpH = messageViewport.clientHeight, contentH = messageContent.scrollHeight;
          if (contentH > vpH) {
              const scroller = document.createElement('div');
              scroller.className = 'message-scroller';
              const copy1 = messageContent.cloneNode(true),
                  copy2 = messageContent.cloneNode(true);
              copy1.style.marginBottom = '1.5em';
              scroller.append(copy1, copy2);
              messageViewport.innerHTML = '';
              messageViewport.appendChild(scroller);
              const duration = (contentH / vpH) * 18;
              const styleId = 'marquee-style';
              document.getElementById(styleId)?.remove();
              const styleEl = document.createElement('style');
              styleEl.id = styleId;
              styleEl.innerHTML = `@keyframes marqueeY { 0% { transform: translateY(0); } 100% { transform: translateY(-${contentH + 24}px); } }`;
              document.head.appendChild(styleEl);
              scroller.style.animation = `marqueeY ${duration}s linear infinite`;
          }
      });
  }

  function renderPrayerList() {
      if (Object.keys(prayerCalendar).length === 0 || Object.keys(jamaatToday).length === 0) return;

      ['Fajr', 'Zuhr', 'Asr', 'Maghrib', 'Isha'].forEach(name => {
          document.getElementById(`${name.toLowerCase()}-start`).textContent = format12NoSuffix(prayerCalendar[name]);
          let jamaat;
          if (name === 'Maghrib') {
              const maghribStartMinutes = hmToMinutes(prayerCalendar.Maghrib);
              jamaat = format12NoSuffix(minutesToHM(maghribStartMinutes !== null ? maghribStartMinutes + 1 : null));
          } else {
              jamaat = format12NoSuffix(jamaatToday[name]);
          }
          document.getElementById(`${name.toLowerCase()}-jamaat`).textContent = jamaat;
      });

      document.getElementById('jummah-1').textContent = format12NoSuffix(jamaatToday.Jumma);
      document.getElementById('jummah-2').textContent = format12NoSuffix(jamaatToday.Jumma2);

      ELS.sunriseTime.textContent = format12NoSuffix(prayerCalendar.Sunrise);
      ELS.zawwalTime.textContent = format12NoSuffix(minutesToHM(hmToMinutes(prayerCalendar.Zuhr) - 15));
      ELS.sunsetTime.textContent = format12NoSuffix(prayerCalendar.Maghrib);
      highlightActive();
  }

  function highlightActive() {
      document.querySelectorAll('.prayer-item.active, .info-mini.active').forEach(el => el.classList.remove('active'));
      if (Object.keys(prayerCalendar).length === 0) return;

      const now = getCurrentTime();
      const nowMin = now.getHours() * 60 + now.getMinutes(),
          isFriday = now.getDay() === 5;

      const fajrStart = hmToMinutes(prayerCalendar.Fajr);
      const sunrise = hmToMinutes(prayerCalendar.Sunrise);
      const zuhrStart = hmToMinutes(prayerCalendar.Zuhr);
      const asrStart = hmToMinutes(prayerCalendar.Asr);
      const maghribStart = hmToMinutes(prayerCalendar.Maghrib);
      const ishaStart = hmToMinutes(prayerCalendar.Isha);

      let activePrayer = '';

      if (ishaStart !== null && (nowMin >= ishaStart || nowMin < fajrStart)) { activePrayer = 'Isha';
      } else if (maghribStart !== null && ishaStart !== null && nowMin >= maghribStart && nowMin < ishaStart - 1) { activePrayer = 'Maghrib';
      } else if (asrStart !== null && maghribStart !== null && nowMin >= asrStart && nowMin < maghribStart - 15) { activePrayer = 'Asr';
      } else if (zuhrStart !== null && asrStart !== null && nowMin >= zuhrStart && nowMin < asrStart - 1) { activePrayer = isFriday ? 'Jummah' : 'Zuhr';
      } else if (fajrStart !== null && sunrise !== null && nowMin >= fajrStart && nowMin < sunrise) { activePrayer = 'Fajr'; }

      if (activePrayer) document.getElementById(`item-${activePrayer.toLowerCase()}`)?.classList.add('active');

      if (sunrise !== null && nowMin >= sunrise && nowMin < sunrise + 15) { ELS.sunriseCard.classList.add('active'); }
      if (zuhrStart !== null && nowMin >= zuhrStart - 15 && nowMin < zuhrStart) { ELS.zawwalCard.classList.add('active'); }
      if (maghribStart !== null && nowMin >= maghribStart - 15 && nowMin < maghribStart) { ELS.sunsetCard.classList.add('active'); }
  }

  function checkPhoneOverlay() {
      if (Object.keys(jamaatToday).length === 0 || Object.keys(prayerCalendar).length === 0) return;
      const now = getCurrentTime();
      const nowMin = now.getHours() * 60 + now.getMinutes(),
          isFriday = now.getDay() === 5;
      const maghribJamaat = hmToMinutes(prayerCalendar.Maghrib) + 1;

      let jamaatTimesSource = [jamaatToday.Fajr, jamaatToday.Asr, minutesToHM(maghribJamaat), jamaatToday.Isha];
      if (isFriday) {
          jamaatTimesSource.push(jamaatToday.Jumma, jamaatToday.Jumma2);
      } else {
          jamaatTimesSource.push(jamaatToday.Zuhr);
      }

      const jamaatTimes = jamaatTimesSource.map(hmToMinutes).filter(t => t !== null);
      const show = jamaatTimes.some(t => nowMin >= t - 1 && nowMin <= t + 5);
      ELS.phoneOverlay.classList.toggle('visible', show);
  }

  async function toggleWakeLock(shouldBeActive) {
      if (shouldBeActive) {
          if ('wakeLock' in navigator && wakeLock === null) {
              try {
                  wakeLock = await navigator.wakeLock.request('screen');
                  wakeLock.addEventListener('release', () => { wakeLock = null; });
                  console.log('Screen Wake Lock is active.');
              } catch (err) { console.error(`Wake Lock failed: ${err.name}, ${err.message}`); }
          }
      } else {
          if (wakeLock !== null) {
              await wakeLock.release();
              wakeLock = null;
          }
      }
  }

  function toggleFullscreen() {
      if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch(e => console.warn(e));
      } else if (document.exitFullscreen) {
          document.exitFullscreen();
      }
  }
  
  async function refreshDailyData() {
      const now = getCurrentTime();
      currentDateStr = now.toISOString().slice(0, 10);

      const dayName = WEEKDAY_NAMES[now.getDay()];
      const dayOfMonth = now.getDate();
      const monthName = MONTH_NAMES[now.getMonth()];
      const year = now.getFullYear();
      ELS.gregorian.textContent = `${dayName}, ${dayOfMonth} ${monthName} ${year}`;

      await fetchHijriDate();
      setupListeners();
  }

  async function initialize() {
      await fetchUKTime();
      await refreshDailyData();

      if (loadCache()) { renderPrayerList(); renderMessage(); }

      ELS.logo.addEventListener('click', toggleFullscreen);
      document.addEventListener('fullscreenchange', () => toggleWakeLock(!!document.fullscreenElement));
      document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'visible' && document.fullscreenElement) {
              toggleWakeLock(true);
          }
      });

      updateClock();
      highlightActive();

      setInterval(() => {
          updateClock();
          highlightActive();
          checkPhoneOverlay();
      }, 1000);

      setInterval(async () => {
          const newDateStr = getCurrentTime().toISOString().slice(0, 10);
          if (newDateStr !== currentDateStr) {
              console.log('Midnight passed. Refreshing daily data...');
              await fetchUKTime();
              await refreshDailyData();
          }
      }, 60000);

      setInterval(fetchUKTime, 1000 * 60 * 60);

      let resizeTimer;
      window.addEventListener('resize', () => {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(renderMessage, 250);
      });
  }

  document.addEventListener('DOMContentLoaded', initialize);

</script>
</body>
</html>


